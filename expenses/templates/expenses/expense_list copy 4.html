{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load crispy_forms_tags %}

{% block title %}Expenses{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Expenses</h2>
  <a href="{% url 'expenses:expense_create' %}" class="btn btn-primary">
    <i class="bi bi-plus"></i> <span class="btn-text">Add Expense</span>
  </a>
  {% include "includes/export_buttons.html" %}
</div>

<form id="expense-filter-form" method="get" class="card card-body mb-3 filters-card">
  <div class="filters-grid">
    <!-- Property / Unit / Category -->
    <select name="property" id="id_property" class="form-select form-select-sm" title="Property">
      <option value="">Property</option>
      {% for p in property_options %}
        <option value="{{ p.id }}" {% if request.GET.property == p.id|stringformat:'s' %}selected{% endif %}>
          {{ p.name }}
        </option>
      {% endfor %}
    </select>

    <select name="unit" id="id_unit" class="form-select form-select-sm" title="Unit" disabled></select>

    <select name="category" id="id_category" class="form-select form-select-sm" title="Category">
      <option value="">Category</option>
      {% for c in category_options %}
        <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:'s' %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>

    <!-- Period (Custom date) -->
    <select name="period" id="id_period" class="form-select form-select-sm" title="Custom date">
      <option value="">All</option>
      <option value="today"      {% if request.GET.period == 'today' %}selected{% endif %}>Today</option>
      <option value="yesterday"  {% if request.GET.period == 'yesterday' %}selected{% endif %}>Yesterday</option>
      <option value="this_week"  {% if request.GET.period == 'this_week' %}selected{% endif %}>This Week</option>
      <option value="last_week"  {% if request.GET.period == 'last_week' %}selected{% endif %}>Last Week</option>
      <option value="this_month" {% if request.GET.period == 'this_month' %}selected{% endif %}>This Month</option>
      <option value="last_month" {% if request.GET.period == 'last_month' %}selected{% endif %}>Last Month</option>
      <option value="this_year"  {% if request.GET.period == 'this_year' %}selected{% endif %}>This Year</option>
    </select>

    <!-- From / To -->
    <input type="date" class="form-control form-control-sm form-select form-select-sm" name="start_date" id="id_start_date"
           value="{{ request.GET.start_date }}" title="From">
    <input type="date" class="form-control form-control-sm form-select form-select-sm" name="end_date" id="id_end_date"
           value="{{ request.GET.end_date }}" title="To">

    <!-- Actions -->
    <button class="btn btn-secondary btn-sm action-btn apply-btn" type="submit" title="Apply">
      <i class="fas fa-filter"></i><span class="btn-text ms-1">Apply</span>
    </button>
    <a class="btn btn-outline-secondary btn-sm action-btn clear-btn" href="?" title="Clear">
      <i class="fas fa-undo"></i><span class="btn-text ms-1">Clear</span>
    </a>
  </div>
</form>

<div class="table-responsive">
  {# IMPORTANT: This expects the updated ExpenseTable (server-side renders mobile lines) #}
  {% render_table table %}
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ========= Auto-submit: Period, dates, Property, Unit, Category ========= */
(function(){
  const form = document.getElementById('expense-filter-form');
  if (!form) return;
  const submit = () => (form.requestSubmit ? form.requestSubmit() : form.submit());
  ['id_period','id_start_date','id_end_date','id_property','id_unit','id_category']
    .forEach(id => document.getElementById(id)?.addEventListener('change', submit));
})();

/* ========= Period → Dates (and auto-submit) ========= */
(function(){
  const periodSel = document.getElementById('id_period');
  const start = document.getElementById('id_start_date');
  const end = document.getElementById('id_end_date');
  const form = document.getElementById('expense-filter-form');

  function fmtLocal(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`;}
  function sow(d){const c=new Date(d);const day=(c.getDay()+6)%7;c.setDate(c.getDate()-day);return c;}
  function eow(d){const s=sow(d);const e=new Date(s);e.setDate(s.getDate()+6);return e;}
  function som(d){return new Date(d.getFullYear(), d.getMonth(), 1);}
  function eom(d){return new Date(d.getFullYear(), d.getMonth()+1, 0);}
  function soy(d){return new Date(d.getFullYear(),0,1);}
  function eoy(d){return new Date(d.getFullYear(),11,31);}

  periodSel?.addEventListener('change', () => {
    const now = new Date(); let s='', e='';
    switch(periodSel.value){
      case 'today': s=e=fmtLocal(now); break;
      case 'yesterday': {const y=new Date(); y.setDate(now.getDate()-1); s=e=fmtLocal(y); break;}
      case 'this_week': s=fmtLocal(sow(now)); e=fmtLocal(eow(now)); break;
      case 'last_week': {const n=new Date(); n.setDate(n.getDate()-7); s=fmtLocal(sow(n)); e=fmtLocal(eow(n)); break;}
      case 'this_month': s=fmtLocal(som(now)); e=fmtLocal(eom(now)); break;
      case 'last_month': {const d=new Date(now.getFullYear(), now.getMonth()-1, 1); s=fmtLocal(som(d)); e=fmtLocal(eom(d)); break;}
      case 'this_year': s=fmtLocal(soy(now)); e=fmtLocal(eoy(now)); break;
      default: s=''; e='';
    }
    start.value = s; end.value = e;
    (form.requestSubmit ? form.requestSubmit() : form.submit());
  });
})();

/* ========= Property → Unit cascade (populate + auto-submit) ========= */
(function(){
  const propertySel = document.getElementById('id_property');
  const unitSel = document.getElementById('id_unit');
  const form = document.getElementById('expense-filter-form');
  const unitsByProp = {{ units_by_property_json|default:"{}"|safe }};

  function populateUnits(){
    const pid = propertySel.value;
    unitSel.innerHTML = '';
    if(!pid){ unitSel.disabled = true; return; }
    const allOpt = document.createElement('option');
    allOpt.value = ''; allOpt.textContent = 'All units';
    unitSel.appendChild(allOpt);
    (unitsByProp[pid] || []).forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id; opt.textContent = u.label;
      if ("{{ request.GET.unit|default_if_none:'' }}" === String(u.id)) opt.selected = true;
      unitSel.appendChild(opt);
    });
    unitSel.disabled = false;
  }

  if (propertySel) {
    propertySel.addEventListener('change', () => { populateUnits(); (form.requestSubmit ? form.requestSubmit() : form.submit()); });
    unitSel.addEventListener('change', () => (form.requestSubmit ? form.requestSubmit() : form.submit()));
    populateUnits();
  }
})();
</script>
<script>
/* ========= Move/clone Receipt link into Actions on small screens ========= */
(function(){
  const table = document.querySelector('.table-responsive table');
  if (!table) return;

  function injectMobileReceiptButtons(){
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const receiptCell = row.querySelector('td.col-receipt a, td.col-receipt button, td.col-receipt .btn'); // tolerate link or button
      const actionsCell = row.querySelector('td.col-actions');

      if (!receiptCell || !actionsCell) return;
      // Avoid duplicates if this runs more than once
      if (actionsCell.querySelector('.receipt-mobile-btn')) return;

      const href = receiptCell.getAttribute('href') || '#';
      const isLink = receiptCell.tagName.toLowerCase() === 'a';

      const btn = document.createElement(isLink ? 'a' : 'button');
      btn.className = 'btn btn-outline-secondary btn-sm action-btn receipt-mobile-btn d-inline d-md-none';
      btn.title = 'Receipt';
      btn.setAttribute('aria-label', 'Open receipt');

      if (isLink) {
        btn.href = href;
        // preserve target if present
        const tgt = receiptCell.getAttribute('target');
        if (tgt) btn.setAttribute('target', tgt);
        else btn.setAttribute('target', '_blank');
        // rel for security
        btn.setAttribute('rel', 'noopener noreferrer');
      } else {
        // If your receipt is a button (e.g., triggers modal), clone its click behavior
        btn.addEventListener('click', e => receiptCell.dispatchEvent(new MouseEvent('click', {bubbles:true})));
      }

      // Use Bootstrap Icons (you already use `bi bi-plus`)
      btn.innerHTML = '<i class="bi bi-receipt"></i>';

      // Put the receipt button at the start of actions for visibility
      actionsCell.prepend(btn);
    });
  }

  // Run once on load
  injectMobileReceiptButtons();

  // If your table re-renders via pagination/filtering (server-side), re-run on DOM changes:
  const observer = new MutationObserver(() => injectMobileReceiptButtons());
  observer.observe(table.tBodies[0], { childList: true, subtree: true });
})();


</script>

{% endblock %}

{% block extra_css %}
<style>
  :root{
  /* Large (≥ md) */
  --w-sn-lg:         64px;
  --w-prop-lg:      120px;
  --w-desc-lg:      220px;
  --w-date-lg:      120px;
  --w-amt-lg:       120px;
  --w-receipt-lg:    80px;
  --w-actions-lg:   160px;
  --fs-table-lg:     14px;

  /* Small (< md) */
  --w-sn-sm:         15px;
  --w-prop-sm:      100px;
  --w-desc-sm:      80px;
  --w-when-sm:       90px;
  --w-receipt-sm:    30px;
  --w-actions-sm:    92px;
  --fs-table-sm:     12px;


  /* Filters grid *//* Filters (small screens) */
  --filter-gap: .35rem;          /* space between items */
  --filter-row-h: 1.6rem;        /* row height on small screens */
  --filter-row-h-sm: 1.6rem;        /* row height on small screens */
  --filter-input-font: .78rem;   /* input font on small screens */
  --filter-input-font-sm: .58rem;   /* input font on small screens */
  --filter-input-pad-y: .05rem;  /* vertical padding inside inputs */
  --filter-input-pad-x: .45rem;  /* horizontal padding inside inputs */

  /* Heading spacing */
  --head-bottom: .5rem;          /* gap below page heading on all screens */
}

/* ========= Heading <-> Filters spacing ========= *//* ===== Heading spacing ===== */
/* OPTION A (no HTML change): shrink the existing heading block */
.d-flex.justify-content-between.align-items-center.mb-4{
  margin-bottom: var(--head-bottom) !important;
}
/* Tighten the filter card itself */
.filters-card{
  margin-top: 0 !important;
  padding: .4rem .6rem;          /* reduce inner padding */
}

/* ================== FILTER BAR ================== */
.filters-card{ padding:.5rem .75rem; }

   .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{
    display: none !important;
  }

.col-actions .btn{ padding: 1px 1px; }
.actions-wrap {  gap: .12rem; align-items: center; }
/* Small screens: stack all controls in HTML order (Property → Unit → Category → Period → From → To → Apply → Clear) */
@media (max-width: 767.98px){
    .table-responsive table th,
  .table-responsive table td{ font-size: var(--fs-table-sm); }

  /* Column widths (phones) */
  .table-responsive .col-sn          { width: var(--w-sn-sm);      min-width: var(--w-sn-sm); }
  .table-responsive .col-property    { min-width: var(--w-prop-sm); }
  .table-responsive .col-desc { min-width: var(--w-desc-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .table-responsive .col-when        { min-width: var(--w-when-sm); }
  .table-responsive .col-receipt     { width: var(--w-receipt-sm); }
  .table-responsive .col-actions     { width: var(--w-actions-sm); }

  /* Date/Amount lines */
  .when-date{ font-weight: 600; line-height: 1.; }
  .when-amt { opacity: .85;     line-height: 1.; }


    /* hide header + cells */
  .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{
    display: none !important;

  .receipt-mobile-btn{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 4px;
    border-radius: .25rem;
  }

  /* Optional: show Unit under Property (already rendered server-side) */
  .prop-mobile-unit{ margin-top:.1rem; font-size: 12px; opacity:.85; }

  /* Actions: icon-only (hide label text safely) */
  .col-actions .btn .btn-text,
  .col-actions .btn .label,
  .col-actions .btn > span:not([class*="bi"]):not([class*="fa"]) {
    display: none !important;
  }



  .col-actions .btn i,
  .col-actions .btn svg{
    width: 10px; height: 10px; font-size: 10px;
  }
  .col-actions .btn{ padding: 2px 2px; }
      /* Actions: icon-only */
  .col-actions .btn .btn-text{ display:none; }


  .filters-grid{
    display: grid;
    /* 3 equal columns */
    grid-template-columns: repeat(3, minmax(0, 1fr));
    /* 3 rows we define with areas below */
    grid-template-areas:
      "property  unit      category"
      "period    start     end"
      "apply     clear     .";
    gap: var(--filter-gap);

   /* ROW HEIGHT CONTROL:
       Use ONE of these two lines:
       1) Same height for all rows -> grid-auto-rows:
    */
    grid-auto-rows: var(--filter-row-h);

    /* 2) Different heights per row -> comment the line above and un-comment:
       grid-template-rows: 2.4rem 2.2rem 2.2rem;
    */
  }

  /* Place each control into a cell */
  #id_property   { grid-area: property; }
  #id_unit       { grid-area: unit; }
  #id_category   { grid-area: category; }
  #id_period     { grid-area: period; }
  #id_start_date { grid-area: start; }
  #id_end_date   { grid-area: end; }
  .apply-btn     { grid-area: apply; width: 100%; }
  .clear-btn     { grid-area: clear; width: 100%; }

/* Make the controls visually match the row height */
  .filters-grid .form-select,
  .filters-grid .form-control{
    height: var(--filter-row-h);
    font-size: var(--filter-input-font);
    padding: var(--filter-input-pad-y) var(--filter-input-pad-x);
    line-height: 1.2;
  }

  /* (Optional) Compact table cells on phones */
  .table-responsive table th,
  .table-responsive table td{
    padding: .8rem .4rem;
    font-size: .78rem;
  }
}

/* ≥ md: single row with fixed widths (adjust to taste) */
@media (min-width: 768px){
  .filters-grid{
    display:flex; align-items:center; gap:.5rem; flex-wrap:nowrap; overflow-x:auto;
  }
  #id_property{ width:240px; }
  #id_unit{ width:200px; }
  #id_category{ width:220px; }
  #id_period{ width:130px; }
  #id_start_date{ width:140px; }
  #id_end_date{ width:140px; }
  .apply-btn{ width:100px; }
  .clear-btn{ width:100px; }

  .filters-grid .form-select,
  .filters-grid .form-control{ height:2rem; font-size:.85rem; padding:.375rem .5rem; }

  .table-responsive table th,
  .table-responsive table td{ font-size: var(--fs-table-lg); }

  .table-responsive .col-sn          { width: var(--w-sn-lg); }
  .table-responsive .col-property    { min-width: var(--w-prop-lg); }
  .table-responsive .col-desc { min-width: var(--w-desc-lg); }
  .table-responsive .col-date        { width: var(--w-date-lg); }
  .table-responsive .col-amount      { width: var(--w-amt-lg); }
  .table-responsive .col-receipt     { width: var(--w-receipt-lg); }
  .table-responsive .col-actions     { width: var(--w-actions-lg); }
}

/* ================== TABLE (pairs with updated ExpenseTable) ================== */
/* Desktop/tablet: optional clamp for category column */
.col-cat{
  max-width: 10rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.col-desc{
  max-width: 20rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Phones (<768px): Description can wrap; mobile lines from server-side renderers are styled here */
@media (max-width: 767.98px){
  .table-responsive table th,
  .table-responsive table td{ font-size: var(--fs-table-sm); }

  .table-responsive .col-sn       { width: var(--w-sn-sm);      min-width: var(--w-sn-sm); }
  .table-responsive .col-property { min-width: var(--w-prop-sm); }
  .table-responsive .col-desc{ min-width: var(--w-desc-sm); }
  .table-responsive .col-when     { min-width: var(--w-when-sm); }
  .table-responsive .col-receipt  { width: var(--w-receipt-sm); }
  .table-responsive .col-actions  { width: var(--w-actions-sm); }

  .col-desc{ white-space: normal; }   /* allow wrapping in Description */

  /* Unit line displayed under Property (added in render_property) */
  .prop-mobile-unit{
    margin-top:.1rem;
    font-size:.72rem;
    opacity:.85;
  }

  /* Category first line inside Description (added in render_description) */
  .desc-mobile-cat .rt-cat{
    display:inline-block;
    max-width: 12rem;        /* tweak as needed */
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
    /* Actions: icon-only */
  .col-actions .btn .btn-text{ display:none; }

  /* Description second line tiny (added in render_description) */
  .desc-mobile-desc{
    font-size:.48rem;
  }
 
}
@media (max-width: 380px){
  .filters-grid{
    grid-template-columns: repeat(3, minmax(0, 1fr));
    grid-template-areas:
      "property  unit      category"
      "period    start     end"
      "apply     clear     .";
    gap: var(--filter-gap);
  }
   /* ROW HEIGHT CONTROL:
       Use ONE of these two lines:
       1) Same height for all rows -> grid-auto-rows:
    */
    grid-template-rows: 1.4rem 1.2rem 1.2rem;
    .filters-grid .form-select,
  .filters-grid .form-control{
    height: var(--filter-row-h-sm);
    font-size: var(--filter-input-font-sm);
    padding: var(--filter-input-pad-y) var(--filter-input-pad-x);
    line-height: 1.2;
  }
  .table-responsive table th,
  .table-responsive table td{ font-size: var(--fs-table-sm); }

  .table-responsive .col-sn       { width: var(--w-sn-sm); }
  .table-responsive .col-property { min-width: var(--w-prop-sm); }
  .table-responsive .col-desc{ min-width: var(--w-desc-sm); }
  .table-responsive .col-date     { width: var(--w-date-sm); }
  .table-responsive .col-amount   { width: var(--w-amt-sm); }
  .table-responsive .col-receipt  { width: var(--w-receipt-sm); }
  .table-responsive .col-actions  { width: var(--w-actions-sm); }

  .table-responsive table th,
  .table-responsive table td{
    padding: .05rem .05rem;
    font-size: .50rem;
    table-layout: fixed;      /* prevent content from auto-expanding columns */
    width: 100%;
  }
  .desc-mobile-desc{
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* set a sensible width so ellipsis can trigger; tweak to taste */
    max-width: 12rem;
  }

}


/* ========= Custom column widths (optional) ========= */
/* If you need non-equal columns on small screens, replace repeat(3,1fr) with custom widths:
   e.g., first column fixed 9rem, others flexible:
   .filters-grid{ grid-template-columns: 9rem 1fr 1fr; }
*/
/* Phones (<768px): hide the dedicated Receipt column, icon-only actions,
   and clamp the SECOND description line to one line with ellipsis */
@media (max-width: 767.98px){
  .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{
    display: none !important;
  } /* <-- this brace was missing in your CSS */

  /* Icon-only actions on phones */
  .col-actions .btn .btn-text{ display: none; } !important

  /* Optional: extra compact touch target for the receipt icon */
  .receipt-mobile-btn{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 4px;
    border-radius: .25rem;
  }

  /* Make sure the description cell itself can shrink */
  .table-responsive td.col-desc,
  .table-responsive th.col-desc{
    min-width: var(--w-desc-sm);
  }

  /* Clamp the SECOND mobile line (desc-mobile-desc) to ONE line */
  td.col-desc .desc-mobile-desc{
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* No fixed width needed; it will use the cell’s width */
  }
}

/* Desktop / tablet (≥768px): enforce a real width so ellipsis can kick in */
@media (min-width: 768px){
  .table-responsive td.col-desc,
  .table-responsive th.col-desc{
    width: var(--w-desc-lg);          /* enforce a working width */
  }

  /* Clamp the big-screen description to one line (the span you render for ≥md) */
  td.col-desc > span.d-md-inline{
    display: block;                   /* needed for ellipsis */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}
@media (max-width: 767.98px){
  .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{ display:none !important; }
}

/* (Keep your other styles as-is) */

</style>
{% endblock %}
