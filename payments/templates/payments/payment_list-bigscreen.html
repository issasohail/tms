{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load humanize %}

{% block title %}Payments{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Payment Records</h2>
    <div class="d-flex gap-2">
        <a href="{% url 'payments:payment_create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Add Payment
        </a>
        {% include "includes/export_buttons.html" %}
    </div>
</div>

<!-- Filter form -->
<div class="card mb-3">
  <div class="card-body p-3">
    <form method="get" id="payment-filter-form">
      <div class="row row-cols-auto g-2 align-items-end">

        <div class="col-auto">
          <label class="form-label mb-1">Property</label>
          <select name="property" id="id_property" class="form-select form-select-sm w-auto" style="min-width: 200px";>
            <option value="">All</option>
            {% for property in all_properties %}
              <option value="{{ property.id }}" {% if current_property == property.id|stringformat:"s" %}selected{% endif %}>
                {{ property.property_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <label class="form-label mb-1">Unit</label>
          <select name="unit" id="id_unit" class="form-select form-select-sm w-auto" style="min-width: 200px";>
            <option value="">All</option>
            {% for unit in filtered_units %}
              <option value="{{ unit.id }}" {% if current_unit == unit.id|stringformat:"s" %}selected{% endif %}>
                {{ unit.unit_number }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <label class="form-label mb-1">Tenant</label>
          <select name="tenant" id="id_tenant" class="form-select form-select-sm select2 w-auto" style="min-width: 300px";>
            <option value="">All</option>
            {% for tenant in tenant_list %}
              <option value="{{ tenant.id }}" {% if current_tenant == tenant.id|stringformat:"s" %}selected{% endif %}>
                {{ tenant.get_full_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <label class="form-label mb-1">Date Range</label>
          <select name="date_range" id="id_date_range" class="form-select form-select-sm w-auto" style="min-width: 200px";>
            <option value="">Custom</option>
            <option value="all" {% if request.GET.date_range == 'all' %}selected{% endif %}>All</option>
            <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
            <option value="yesterday" {% if request.GET.date_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
            <option value="this_week" {% if request.GET.date_range == 'this_week' %}selected{% endif %}>This Week</option>
            <option value="last_week" {% if request.GET.date_range == 'last_week' %}selected{% endif %}>Last Week</option>
            <option value="this_month" {% if request.GET.date_range == 'this_month' %}selected{% endif %}>This Month</option>
            <option value="last_month" {% if request.GET.date_range == 'last_month' %}selected{% endif %}>Last Month</option>
            <option value="this_year" {% if request.GET.date_range == 'this_year' %}selected{% endif %}>This Year</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="form-label mb-1 w-auto" style="min-width: 100px";>From</label>
          <input type="date" name="start_date" id="id_start_date" class="form-control form-control-sm" value="{{ request.GET.start_date }}">
        </div>

        <div class="col-auto">
          <label class="form-label mb-1 w-auto" style="min-width: 100px";>To</label>
          <input type="date" name="end_date" id="id_end_date" class="form-control form-control-sm" value="{{ request.GET.end_date }}">
        </div>
  
  </div>

</div>
   </form>
<!-- Total Amount Display -->
<div class="card mb-2 mt-2" id="total-card" style="display:none">
  <div class="card-body py-2 px-3">
    <div class="d-flex justify-content-between align-items-left">
      <span class="fw-bold small">Payments Received:</span>
      <span class="fw-bold text-success total-amount-display"></span>
    </div>
  </div>
</div>

<div class="table-responsive">
    {% render_table table %}
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container--default .select2-selection--single {
        height: 38px;
        padding-top: 5px;
    }
    .form-check {
        min-height: 38px;
        display: flex;
        align-items: center;
    }
    .form-label {
    font-size: 0.85rem;
    }
    .form-select-sm, .form-control-sm {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }
    .select2-container--default .select2-selection--single {
        height: 32px !important;
        line-height: 32px !important;
        padding: 0 6px;
        font-size: 0.85rem;
    }
    .select2-selection__arrow {
        height: 32px !important;
    }

  /* existing styles ... */
  .truncate-25 {
    max-width: 25ch;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline-block;
    vertical-align: bottom;
  }




{{ block.super }}

  /* ---------- Small-screen settings (≤ 420px) ---------- */
  @media (max-width: 420px) {
    /* Global type scale */
    html { font-size: 14px; } /* base */
    h2 { font-size: .9rem; }      /* smaller heading */
    .form-label,
    .form-select-sm,
    .form-control-sm,
    .select2-container--default .select2-selection--single {
      font-size: .68rem !important; /* requested */
    }
    /* Smaller action buttons */
    .btn.btn-sm {
      font-size: .68rem;
      padding: .25rem .35rem;
      line-height: 1.1;
    }

    /* Filter grid: two columns; rows map naturally by DOM order:
       Row1: Property | Unit
       Row2: Tenant   | Date Range
       Row3: From     | To
    */
    #payment-filter-form .row.row-cols-auto {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: .5rem .5rem;
    }
    #payment-filter-form .row.row-cols-auto > .col-auto {
      width: 100% !important;
    }
    /* Make selects full-width and compact */
    #payment-filter-form .form-select-sm,
    #payment-filter-form .form-control-sm,
    #payment-filter-form .select2,
    #payment-filter-form .select2-selection--single {
      width: 100% !important;
      min-width: 0 !important;
    }

    /* Table: mobile typography + wrapping */
    table.table {
      --col-sn: 50px;
      --col-id: 60px;
      --col-tenant: 170px;
      --col-property: 170px;
      --col-unit: 90px;      /* hidden on mobile but kept as variable */
      --col-date: 120px;
      --col-amount: 120px;
      --col-method: 110px;   /* hidden on mobile but kept as variable */
      --col-balance: 120px;  /* hidden on mobile but kept as variable */
      --col-actions: 96px;

      font-size: .58rem; /* requested table font size */
      white-space: normal; /* allow wrap on small screens */
    }

    /* Ellipsis utility for overflowing single-line chunks */
    .ellipsis {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: bottom;
    }

    /* Hide label text inside action buttons; show only icons */
    .actions-wrap .btn .btn-label { display: none !important; }

    /* Column width hooks (tweak via the CSS variables above) */
    th.col-sn,      td.col-sn      { width: var(--col-sn); }
    th.col-id,      td.col-id      { width: var(--col-id); }
    th.col-tenant,  td.col-tenant  { width: var(--col-tenant); }
    th.col-property,td.col-property{ width: var(--col-property); }
    th.col-unit,    td.col-unit    { width: var(--col-unit); }
    th.col-date,    td.col-date    { width: var(--col-date); }
    th.col-amount,  td.col-amount  { width: var(--col-amount); }
    th.col-method,  td.col-method  { width: var(--col-method); }
    th.col-balance, td.col-balance { width: var(--col-balance); }
    th.col-actions, td.col-actions { width: var(--col-actions); }

    /* Hide these columns entirely on small screens */
    th.col-id,      td.col-id,
    th.col-unit,    td.col-unit,
    th.col-method,  td.col-method,
    th.col-balance, td.col-balance {
      display: none !important;
    }

    /* Make each row "stack" second-line metadata under certain cells */
    /*  We inject the hidden column values into visible cells via JS below. */

    /* Table header cleanup for small screens (shorter titles) */
    thead th { font-size: .62rem; }
  }
</style>
{% endblock %}



{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Initialize Select2 (we’ll customize display below)
  $('#id_tenant').select2({
    placeholder: "Search tenant...",
    allowClear: true,
    width: '100%',
    // Truncate to 35 chars in the dropdown + selection
    templateResult: function (data) {
      if (!data.id) return data.text;
      const full = data.text || '';
      const short = full.length > 35 ? (full.slice(0, 35) + '…') : full;
      const $el = $('<span>').text(short).attr('title', full);
      return $el;
    },
    templateSelection: function (data) {
      const full = data.text || '';
      const short = full.length > 35 ? (full.slice(0, 35) + '…') : full;
      return short;
    }
  });

  // Auto-open & autofocus search box when tenant filter is focused/opened
  $('#id_tenant').on('focus', function () {
    $(this).select2('open');
  });
  $('#id_tenant').on('select2:opening', function () {
    setTimeout(function () {
      $('.select2-container .select2-search__field').trigger('focus');
    }, 0);
  });

  function hasDateFilter() {
    const dr = $('#id_date_range').val();
    const s = $('#id_start_date').val();
    const e = $('#id_end_date').val();
    return (dr && dr !== '') || !!s || !!e;
  }

    // Auto-submit form when include_inactive checkbox changes
    $('#id_include_inactive').change(function() {
        updateTotalAmount();
        $('#payment-filter-form').submit();
    });

    // Property change - reset tenant filter
    $('#id_property').change(function() {
        $('#id_tenant').val('').trigger('change');
        $('#id_date_range').val('').trigger('change');
        $('#id_start_date').val('');
        $('#id_end_date').val('');
        updateTotalAmount();
        $('#payment-filter-form').submit();
    });

    // Unit change - reset tenant filter
    $('#id_unit').change(function() {
        $('#id_tenant').val('').trigger('change');
        $('#id_date_range').val('');
        $('#id_start_date').val('');
        $('#id_end_date').val('');
        updateTotalAmount();
        $('#payment-filter-form').submit();
    });

    // Tenant change - reset property and unit filters
    $('#id_tenant').change(function() {
        if ($(this).val()) {
            $('#id_property').val('');
            $('#id_unit').val('');
            $('#id_date_range').val('');
            $('#id_start_date').val('');
            $('#id_end_date').val('');
        }
        updateTotalAmount();
        $('#payment-filter-form').submit();
    });

    // Status change - auto submit
    $('#id_status').change(function() {
        updateTotalAmount();
        $('#payment-filter-form').submit();
    });

    // Date range preset change
    $('#id_date_range').change(function() {
        if ($(this).val()) {
            $('#id_property').val('');
            $('#id_unit').val('');
            $('#id_tenant').val('').trigger('change');
            // Clear the manual date inputs when a preset is selected
            $('#id_start_date').val('');
            $('#id_end_date').val('');
        }
        updateTotalAmount();
        $('#payment-filter-form').submit();
    });

    let dateTimeout;
    // Date inputs change - auto submit
    $('#id_start_date, #id_end_date').on('change input', function () {
        clearTimeout(dateTimeout);
        dateTimeout = setTimeout(function () {
            const startDate = $('#id_start_date').val();
            const endDate = $('#id_end_date').val();
        
            if (startDate || endDate) {
                $('#id_date_range').val('');
                updateTotalAmount();
                $('#payment-filter-form').submit();
            }
        }, 1000); // wait 500ms    
    });



    // Set date values based on preset when page loads
    function setDateRangePreset() {
        const preset = $('#id_date_range').val();
        let startDate = '';
        let endDate = '';
        const today = new Date();
        
        if (preset === 'today') {
            startDate = endDate = formatDate(today);
        } else if (preset === 'yesterday') {
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            startDate = endDate = formatDate(yesterday);
        } else if (preset === 'this_week') {
            const firstDay = new Date(today);
            firstDay.setDate(firstDay.getDate() - firstDay.getDay()); // Sunday
            const lastDay = new Date(today);
            lastDay.setDate(lastDay.getDate() + (6 - lastDay.getDay())); // Saturday
            startDate = formatDate(firstDay);
            endDate = formatDate(lastDay);
        } else if (preset === 'last_week') {
            const firstDay = new Date(today);
            firstDay.setDate(firstDay.getDate() - firstDay.getDay()-7); // Sunday
            const lastDay = new Date(today);
            lastDay.setDate(lastDay.getDate() + (6 - lastDay.getDay())-7); // Saturday
            startDate = formatDate(firstDay);
            endDate = formatDate(lastDay);
        } else if (preset === 'this_month') {
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            startDate = formatDate(firstDay);
            endDate = formatDate(lastDay);
        } else if (preset === 'last_month') {
            const firstDay = new Date(today.getFullYear(), today.getMonth()-1, 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth()-1 + 1, 0);
            startDate = formatDate(firstDay);
            endDate = formatDate(lastDay);
        } else if (preset === 'this_year') {
            const firstDay = new Date(today.getFullYear(), 0, 1);
            const lastDay = new Date(today.getFullYear(), 11, 31);
            startDate = formatDate(firstDay);
            endDate = formatDate(lastDay);
        }
        
        if (startDate && endDate) {
            $('#id_start_date').val(startDate);
            $('#id_end_date').val(endDate);
        }
    }
    
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Initialize date presets on page load
    setDateRangePreset();
     // Do NOT fetch or show total on page load unless a date filter is present
  if (hasDateFilter()) {
    updateTotalAmount();
  }
});

// Add this to your existing JavaScript
function updateTotalAmount() {
    // Get all form data
    const formData = $('#payment-filter-form').serialize();

      // guard: no date filter chosen yet → hide the card and bail
    const hasAnyDate =
      ($('#id_date_range').val() && $('#id_date_range').val() !== '') ||
      $('#id_start_date').val() || $('#id_end_date').val();

    if (!hasAnyDate) {
      $('#total-card').hide();
      return;
    }

  // show card, then populate
  $('#total-card').show();
    
    // Make AJAX request to get updated total
    $.ajax({
      url: window.location.pathname,
      data: formData + '&ajax=1',
      success: function(data) {
        if (data.total_amount !== undefined && data.total_amount !== null) {
          const formatted = '$' + parseFloat(data.total_amount)
            .toFixed(2)
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          $('.total-amount-display').text(formatted);
        } else {
          // if your view ever returns nothing, clear the display safely
          $('.total-amount-display').text('$0.00');
        }
      }
    });
}

$(document).ready(function() {
    // Add to all your existing filter change handlers
    $('#id_property, #id_unit, #id_tenant, #id_status, #id_date_range, #id_start_date, #id_end_date').change(function() {
        updateTotalAmount();
    });
    
    // Also call it on page load
    updateTotalAmount();
});

function sendWhatsAppSingle(paymentId, phone, firstName, propertyName, unitNumber, amount, paymentDate, balance) {
    if (!phone.trim()) {
        alert("No phone number available for WhatsApp.");
        return;
    }

    // Clean up phone number (same logic as in detail view)
    let cleanedPhone = phone.replace(/[^\d]/g, '');
    if (cleanedPhone.startsWith('0')) {
        cleanedPhone = '+92' + cleanedPhone.substring(1);
    } else if (!cleanedPhone.startsWith('+')) {
        cleanedPhone = cleanedPhone; // fallback if user entered without 0 or 92
    }

    // Compose message (similar to detail view)
    const message = `
Dear ${firstName},
Payment received for 
Unit: ${propertyName}-${unitNumber}
Amount:  ${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
Date: ${paymentDate}
Balance:  ${parseFloat(balance).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}

Thank you!
`.trim();

    // Open WhatsApp
    const waUrl = `https://api.whatsapp.com/send?phone=${cleanedPhone}&text=${encodeURIComponent(message)}`;
    window.open(waUrl, '_blank');
}



(function () {
  const MOBILE_MAX = 420;
  const SELECTOR_TABLE = 'table.table';
  const already = new WeakSet();

  function enhanceMobileRows() {
    if (window.innerWidth > MOBILE_MAX) return;

    document.querySelectorAll(SELECTOR_TABLE + ' tbody tr').forEach(tr => {
      if (already.has(tr)) return;
      const tds = Array.from(tr.children);

      // Map columns by the classes we’ll add from tables.py (below)
      const get = (cls) => tr.querySelector('td.' + cls);

      const tdProperty = get('col-property');
      const tdUnit     = get('col-unit');
      const tdAmount   = get('col-amount');
      const tdMethod   = get('col-method');
      const tdDate     = get('col-date');
      const tdBalance  = get('col-balance');

      // Helper: make a subtle second-row line
      const makeSub = (label, value) => {
        if (!value) return null;
        const wrap = document.createElement('div');
        wrap.className = 'mt-1 text-muted';
        wrap.style.fontSize = '.58rem';
        wrap.style.lineHeight = '1.1';
        wrap.innerHTML = '<strong>' + label + ':</strong> ' +
          '<span class="ellipsis" title="' + value + '">' + value + '</span>';
        return wrap;
      };

      if (tdProperty && tdUnit) {
        const unitText = tdUnit.textContent.trim();
        const sub = makeSub('Unit', unitText);
        if (sub) tdProperty.appendChild(sub);
      }

      if (tdAmount && tdMethod) {
        const methodText = tdMethod.textContent.trim();
        const sub = makeSub('Method', methodText);
        if (sub) tdAmount.appendChild(sub);
      }

      if (tdDate && tdBalance) {
        const balanceText = tdBalance.textContent.trim();
        const sub = makeSub('Balance', balanceText);
        if (sub) tdDate.appendChild(sub);
      }

      // Mark so we don’t duplicate if called again
      already.add(tr);
    });
  }

  // Run after table render
  document.addEventListener('DOMContentLoaded', enhanceMobileRows);
  window.addEventListener('resize', () => {
    // Only enhance when going below the threshold
    if (window.innerWidth <= MOBILE_MAX) enhanceMobileRows();
  });
})();
</script>



{% endblock %}