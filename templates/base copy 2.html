{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{% block title %}Tenant Management System{% endblock %}</title>

  <!-- Favicons -->
  <link rel="icon" href="{% static 'images/favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">
  <link rel="apple-touch-icon" href="{% static 'images/apple-touch-icon.png' %}">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- Bootstrap Icons (for bi bi-plus, etc.) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Select2 CSS + Bootstrap 5 theme -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

  <!-- Font Awesome 5 (for fas fa-* icons used in templates) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <!-- Your app CSS -->
  <link rel="stylesheet" href="{% static 'leases/css/base.css' %}">
  <link rel="stylesheet" href="{% static 'leases/css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/tenant_table.css' %}">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">


  <style>

    /* Fix: add unit to margin */
    nav.navbar { margin-bottom: 1rem !important; }
    nav.navbar + .container,
    nav.navbar + main.container { margin-top: 0 !important; }

    /* Tighter navbar + smaller text on very small screens (≤360px) */
    @media (max-width: 360px){
      nav.navbar { padding-top: .20rem !important; padding-bottom: .20rem !important; }
      body, .btn, .form-select, .form-control, table { font-size: .70rem; }
    }



    /* ===== Global action-button spacing ===== */
    :root{
      /* Button padding (inside each button) */
      --action-btn-px: .05rem;
      --action-btn-py: .35rem;
      --action-btn-minw: 2.25rem; /* prevents ultra-thin buttons when very narrow */

      /* Gap between buttons inside the action group */
      --action-btn-gap: .04rem;

      /* Outer spacing of the whole action group (top/right/bottom/left) */
      --action-group-mt: 0rem;
      --action-group-mr: 0rem;
      --action-group-mb: 0rem;
      --action-group-ml: 0rem;
    }

    /* The container that holds your row/page action buttons */
    .actions-wrap{
      display: inline-flex;          /* stays compact inside tables */
      flex-wrap: wrap;               /* wraps on small screens */
      align-items: center;
      gap: var(--action-btn-gap);
      width: 100%;            /* lets the group expand to fill its cell/row */
      flex-wrap: nowrap;      /* keep in one line; change to wrap if you prefer */
      margin-top:    var(--action-group-mt);
      margin-right:  var(--action-group-mr);
      margin-bottom: var(--action-group-mb);
      margin-left:   var(--action-group-ml);
    }

    /* Each action button (anchor or button) */
    .actions-wrap .action-btn{
      flex: 1 1 0;            /* <- the magic: all buttons share remaining width equally */
      display: inline-flex;
      justify-content: center;
      align-items: center;
      min-width: var(--action-btn-minw);
      padding: var(--action-btn-py) var(--action-btn-px) !important;
      line-height: 1.1;
      text-align: center;
      white-space: nowrap;
    }

    /* Optional: make icons align nicely even when text is hidden */
    .action-btn i, .action-btn .bi, .action-btn .fas, .action-btn .far, .action-btn .fab {
      display: inline-block;
      vertical-align: middle;
    }

    /* Optional: keep actions from squishing too much inside narrow tables */
    .table .actions-wrap{
      min-width: 120px; /* adjust if needed */
    }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>
  {% include 'partials/navbar.html' %}

  <!-- Django messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="container mt-0">
    {% block content %}{% endblock %}
  </div>




  <footer class="mt-5 py-3 bg-light">
    <div class="container text-center">
      <p class="mb-0">Tenant Management System &copy; {% now "Y" %}</p>
    </div>
  </footer>

  <!-- Scripts (order matters) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  {% block extra_js %}{% endblock %}

  <script>
    // Auto-close alerts after 5s & init Select2 if used on a page
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        document.querySelectorAll('.alert').forEach(function(el){
          if (window.bootstrap?.Alert) new bootstrap.Alert(el).close();
        });
      }, 5000);

      if (window.$?.fn?.select2) {
        $('#tenant-select').select2({ theme: 'bootstrap-5', placeholder: "Search Tenant", allowClear: true });
        $('#unit-select').select2({ theme: 'bootstrap-5', placeholder: "Search Unit", allowClear: true });
      }
    });
  </script>

  <!-- Reusable receipt viewer modal -->
  <div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-9">
              <img id="receiptMain" src="" alt="Receipt" class="img-fluid w-100 rounded border" style="max-height:75vh; object-fit:contain;">
            </div>
            <div class="col-12 col-md-3">
              <div id="receiptThumbs" class="d-flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <small class="text-muted">Tip: click a thumbnail to switch</small>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt modal opener (works with any .view-receipt link that has data-urls="url1|url2|..." ) -->
  <script>
    (function(){
      function openGallery(urls){
        const main = document.getElementById('receiptMain');
        const thumbs = document.getElementById('receiptThumbs');
        if (!urls || !urls.length || !main || !thumbs) return;

        main.src = urls[0];
        thumbs.innerHTML = '';
        urls.forEach(u => {
          const img = document.createElement('img');
          img.src = u;
          img.className = 'img-thumbnail';
          img.style.width = '80px';
          img.style.height = '80px';
          img.style.objectFit = 'cover';
          img.style.cursor = 'pointer';
          img.addEventListener('click', ()=> main.src = u);
          thumbs.appendChild(img);
        });

        if (window.bootstrap && bootstrap.Modal) {
          new bootstrap.Modal(document.getElementById('receiptModal')).show();
        } else {
          window.open(urls[0], '_blank'); // fallback
        }
      }

      // Event delegation (supports paginated/HTMX tables)
      document.addEventListener('click', function(e){
        const a = e.target.closest('.view-receipt');
        if (!a) return;
        e.preventDefault();
        const urls = (a.dataset.urls || '').split('|').filter(Boolean);
        openGallery(urls);
      }, false);
    })();
  </script>

  <!-- base.html -->
<script>
  // Build a dynamic URL pattern for fetching an invoice WhatsApp message
  // NOTE: replace final "0" with the invoice id at runtime.
  window.WA_INVOICE_MSG_URL = "{% url 'invoices:invoice_whatsapp_message' 0 %}".replace(/0\/?$/, "__ID__/");

  // Open WA with any phone/message pair
  window.openWhatsApp = function (phone, message) {
    // Step 1: Clean up number
    // Assumes tenant is in Pakistan (country code +92)
    let phone = rawPhone.replace(/[^\d]/g, ''); // remove non-digits

    const cleaned = String(phone || '').replace(/[^\d+]/g, '');
      if (!cleaned) { alert("No phone number for this tenant."); return; }

    if (phone.startsWith('0')) {
        phone = '+92' + phone.substring(1);
    } else if (!phone.startsWith('+')) {
        phone =  phone; // fallback if user entered without 0 or 92
    }

    
    const url = `https://wa.me/${encodeURIComponent(cleaned)}?text=${encodeURIComponent(message || '')}`;
    window.open(url, "_blank");
  };

  // Fetch message by invoice id, then open WA
  window.openWhatsAppForInvoiceId = async function (invoiceId) {
    if (!invoiceId) return;
    const url = window.WA_INVOICE_MSG_URL.replace("__ID__", String(invoiceId));
    try {
      const res = await fetch(url, { credentials: "same-origin" });
      if (!res.ok) throw new Error("Failed to fetch message");
      const data = await res.json();
      if (!data?.phone) { alert("No phone number on this invoice's tenant."); return; }
      window.openWhatsApp(data.phone, data.message || "");
    } catch (e) {
      console.error(e);
      alert("Could not prepare the WhatsApp message right now.");
    }
  };

  // Optional convenience if you prefer passing a prebuilt endpoint URL as data attribute
  window.openWhatsAppForInvoiceUrl = async function (endpointUrl) {
    if (!endpointUrl) return;
    try {
      const res = await fetch(endpointUrl, { credentials: "same-origin" });
      if (!res.ok) throw new Error("Failed to fetch message");
      const data = await res.json();
      if (!data?.phone) { alert("No phone number on this invoice's tenant."); return; }
      window.openWhatsApp(data.phone, data.message || "");
    } catch (e) {
      console.error(e);
      alert("Could not prepare the WhatsApp message right now.");
    }
  };
</script>

  <!-- HTMX (optional, keep if you use it) -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>


<script>
  // Pattern URLs (Django will fill these in); we swap __ID__ at runtime.
  // Make sure these URL names exist in your urls.py files (added below).
    window.WA_INVOICE_MSG_URL = "{% url 'invoices:api_invoice_whatsapp' 0 %}".replace('/0/', '/__ID__/');
  window.WA_PAYMENT_MSG_URL = "{% url 'payments:api_payment_receipt_whatsapp' 0 %}".replace('/0/', '/__ID__/');


  // Open WhatsApp with phone + message
  window.openWhatsApp = function (phone, message) {
    const cleaned = String(phone || '').replace(/[^\d+]/g, '');
    if (!cleaned) { alert("No phone number for this tenant."); return; }
    const u = `https://wa.me/${encodeURIComponent(cleaned)}?text=${encodeURIComponent(message || '')}`;
    window.open(u, "_blank");
  };

  // Generic fetcher
  async function fetchWhatsAppPayload(url) {
    const res = await fetch(url, { credentials: "same-origin", headers: { "X-Requested-With": "XMLHttpRequest" } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  // Invoice → WA
  window.openWhatsAppForInvoiceId = async function (invoiceId) {
    try {
      const data = await fetchWhatsAppPayload(window.WA_INVOICE_MSG_URL.replace("__ID__", String(invoiceId)));
      if (!data?.phone) { alert("No phone number on this invoice's tenant."); return; }
      window.openWhatsApp(data.phone, data.message || "");
    } catch (e) {
      console.error(e); alert("Could not prepare the WhatsApp message right now.");
    }
  };

  // Payment (receipt) → WA
  window.openWhatsAppForPaymentId = async function (paymentId) {
    try {
      const data = await fetchWhatsAppPayload(window.WA_PAYMENT_MSG_URL.replace("__ID__", String(paymentId)));
      if (!data?.phone) { alert("No phone number on this payment's tenant."); return; }
      window.openWhatsApp(data.phone, data.message || "");
    } catch (e) {
      console.error(e); alert("Could not prepare the WhatsApp message right now.");
    }
  };
</script>

</body>
</html>
