{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load humanize %}

{% block title %}Tenant Ledger - {{ tenant }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2>
            Ledger for {{ tenant.get_full_name }}
            {% if lease %}
                - {{ lease.unit.property.property_name }} - {{ lease.unit.unit_number }}
            {% endif %}
        </h2>
        <div class="btn-group">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-download me-1"></i> Export
            </button>
            <ul class="dropdown-menu">
                {% for format in export_formats %}
                <li>
                    <a class="dropdown-item" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}_export={{ format }}">
                        {{ format|upper }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print me-1"></i> Print
            </button>
            <button class="btn btn-success" onclick="sendWhatsAppLedger()">
                <i class="fab fa-whatsapp me-1"></i> WhatsApp
            </button>
            <button class="btn btn-info" onclick="sendEmailLedger()">
                <i class="fas fa-envelope me-1"></i> Email
            </button>
        </div>
    </div>

    <div class="card-body">
        <form method="get" id="ledger-filter-form">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="id_date_range" class="form-label">Date Range</label>
                    <select name="date_range" id="id_date_range" class="form-select">
                        <option value="">Custom Range</option>
                        <option value="today" {% if current_date_range == 'today' %}selected{% endif %}>Today</option>
                        <option value="this_week" {% if current_date_range == 'this_week' %}selected{% endif %}>This Week</option>
                        <option value="this_month" {% if current_date_range == 'this_month' %}selected{% endif %}>This Month</option>
                        <option value="last_month" {% if current_date_range == 'last_month' %}selected{% endif %}>Last Month</option>
                        <option value="all" {% if current_date_range == 'all' %}selected{% endif %}>All Dates</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="id_start_date" class="form-label">From Date</label>
                    <input type="date" name="start_date" id="id_start_date" class="form-control" 
                           value="{{ current_start_date }}">
                </div>
                
                <div class="col-md-3">
                    <label for="id_end_date" class="form-label">To Date</label>
                    <input type="date" name="end_date" id="id_end_date" class="form-control" 
                           value="{{ current_end_date }}">
                </div>
                
                <div class="col-md-3">
                    <label for="id_tenant" class="form-label">Tenant</label>
                    <select name="tenant" id="id_tenant" class="form-select select2">
                        <option value="">All Tenants</option>
                        {% for tenant in tenant_list %}
                            <option value="{{ tenant.id }}"
                                {% if current_tenant == tenant.id|stringformat:"s" %}selected{% endif %}>
                                {{ tenant.get_full_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Filter</button>
                    {% if request.GET %}
                        <a href="?" class="btn btn-outline-secondary">Clear</a>
                    {% endif %}
                </div>
            </div>
        </form>

        <div class="table-responsive">
            {% render_table table %}
        </div>

        <div class="mt-4">
            <div class="alert alert-info">
                <h5 class="mb-0">Current Balance: 
                    <span class="float-end">
                        {% with last_transaction=transactions|last %}
                            ${{ last_transaction.balance|floatformat:2|intcomma }}
                        {% endwith %}
                    </span>
                </h5>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Add to your existing JavaScript
$('#id_tenant').select2({
    placeholder: "Search tenant...",
    allowClear: true,
    width: '100%'
});

// Add tenant filter change handler
$('#id_tenant').change(function() {
    $('#ledger-filter-form').submit();
});

function sendWhatsAppLedger() {
    const tenant = {
        name: "{{ tenant.get_full_name }}",
        phone: "{{ tenant.phone }}",
        property: "{{ lease.unit.property.property_name|default:'N/A' }}",
        unit: "{{ lease.unit.unit_number|default:'N/A' }}",
        balance: parseFloat("{% with last_transaction=transactions|last %}{{ last_transaction.balance }}{% endwith %}").toFixed(2)
    };

    if (!tenant.phone.trim()) {
        alert("No phone number available for WhatsApp.");
        return;
    }

    // Clean up phone number
    let cleanedPhone = tenant.phone.replace(/[^\d]/g, '');
    if (cleanedPhone.startsWith('0')) {
        cleanedPhone = '+92' + cleanedPhone.substring(1);
    } else if (!cleanedPhone.startsWith('+')) {
        cleanedPhone = '+' + cleanedPhone;
    }

    // Compose message
    const message = `
*Ledger Summary for ${tenant.name}*

Property: ${tenant.property}
Unit: ${tenant.unit}
Current Balance: ${tenant.balance}

View full ledger: ${window.location.href}
`.trim();

    // Open WhatsApp
    const waUrl = `https://api.whatsapp.com/send?phone=${cleanedPhone}&text=${encodeURIComponent(message)}`;
    window.open(waUrl, '_blank');
}

function sendEmailLedger() {
    const tenantId = "{{ tenant.id }}";
    const url = "{% url 'tenants:send_ledger' tenant.id %}";
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Ledger sent successfully to ' + data.email);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send ledger');
    });
}

// Date range preset handling
document.addEventListener("DOMContentLoaded", function() {
    $('#id_date_range').change(function() {
        const preset = $(this).val();
        if (preset) {
            $('#id_start_date').val('');
            $('#id_end_date').val('');
        }
    });
    
    $('#id_start_date, #id_end_date').change(function() {
        if ($(this).val()) {
            $('#id_date_range').val('');
        }
    });
});
</script>
{% endblock %}