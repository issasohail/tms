{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
<link rel="stylesheet" href="{% static 'properties/css/tables.css' %}">

{% block title %}Units{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Units</h2>
    <div class="d-flex gap-2">
        <a href="{% url 'properties:unit_create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Add Unit
        </a>
        
        {% include "includes/export_buttons.html" %}
    </div>
</div>

<!-- Filter form -->
<div class="card mb-4">
    <div class="card-body p-3">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-md-4">
                <label for="id_property" class="form-label">Property</label>
                <select name="property" id="id_property" class="form-select" onchange="this.form.submit()">
                    <option value="">All Properties</option>
                    {% for property in all_properties %}
                        <option value="{{ property.id }}"
                            {% if request.GET.property|stringformat:"s" == property.id|stringformat:"s" %}selected{% endif %}>
                            {{ property.property_name }} - ({{ property.units.count }} units)
                        </option>
                    {% empty %}
                        <option value="">No properties available</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary mt-3">Filter</button>
                {% if request.GET.property %}
                    <a href="?" class="btn btn-outline-secondary mt-3">Clear</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>


    {% csrf_token %}
<div class="table-responsive">
    {% render_table table %}
</div>



    {% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block extra_js %}
<script>
// Select/Deselect all checkboxes
    document.getElementById('select-all').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('input[name="selected_units"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("td[data-editable='true']").forEach(function (td) {
        td.addEventListener("dblclick", function () {
            const field = td.dataset.field;
            const id = td.dataset.id;
            const current = td.innerText.trim();

            const input = document.createElement("input");
            input.type = "text";
            input.value = current;
            input.className = "form-control";
            td.innerHTML = "";
            td.appendChild(input);
            input.focus();

            input.addEventListener("blur", function () {
                fetch("{% url 'properties:unit_inline_update' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        id: id,
                        field: field,
                        value: input.value
                    })
                }).then(res => res.json()).then(data => {
                    td.innerText = data.new_value || input.value;
                }).catch(err => {
                    console.error(err);
                    td.innerText = current;
                });
            });
        });
    });
});



document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("td[data-editable='true']").forEach(td => {
        td.addEventListener("dblclick", function () {
            const field = td.dataset.field;
            const id = td.dataset.id;
            const current = td.innerText.trim();

            const input = document.createElement("input");
            input.type = "text";
            input.value = current;
            input.className = "form-control";
            td.innerHTML = "";
            td.appendChild(input);
            input.focus();

            input.addEventListener("blur", function () {
                fetch("{% url 'properties:unit_inline_update' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        id: id,
                        field: field,
                        value: input.value
                    })
                }).then(res => res.json()).then(data => {
                    td.innerText = data.new_value || input.value;
                }).catch(err => {
                    console.error(err);
                    td.innerText = current;
                });
            });
        });
    });
});


    
</script>
{% endblock %}
