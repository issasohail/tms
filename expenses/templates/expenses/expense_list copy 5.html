{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load crispy_forms_tags %}

{% block title %}Expenses{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Expenses</h2>
  <a href="{% url 'expenses:expense_create' %}" class="btn btn-primary">
    <i class="bi bi-plus"></i> <span class="btn-text">Add Expense</span>
  </a>
  {% include "includes/export_buttons.html" %}
</div>

<form id="expense-filter-form" method="get" class="card card-body mb-3 filters-card">
  <div class="filters-grid">
    <!-- Property / Unit / Category -->
    <select name="property" id="id_property" class="form-select form-select-sm" title="Property">
      <option value="">Property</option>
      {% for p in property_options %}
        <option value="{{ p.id }}" {% if request.GET.property == p.id|stringformat:'s' %}selected{% endif %}>
          {{ p.name }}
        </option>
      {% endfor %}
    </select>

    <select name="unit" id="id_unit" class="form-select form-select-sm" title="Unit" disabled></select>

    <select name="category" id="id_category" class="form-select form-select-sm" title="Category">
      <option value="">Category</option>
      {% for c in category_options %}
        <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:'s' %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>

    <!-- Period (Custom date) -->
    <select name="period" id="id_period" class="form-select form-select-sm" title="Custom date">
      <option value="">All</option>
      <option value="today"      {% if request.GET.period == 'today' %}selected{% endif %}>Today</option>
      <option value="yesterday"  {% if request.GET.period == 'yesterday' %}selected{% endif %}>Yesterday</option>
      <option value="this_week"  {% if request.GET.period == 'this_week' %}selected{% endif %}>This Week</option>
      <option value="last_week"  {% if request.GET.period == 'last_week' %}selected{% endif %}>Last Week</option>
      <option value="this_month" {% if request.GET.period == 'this_month' %}selected{% endif %}>This Month</option>
      <option value="last_month" {% if request.GET.period == 'last_month' %}selected{% endif %}>Last Month</option>
      <option value="this_year"  {% if request.GET.period == 'this_year' %}selected{% endif %}>This Year</option>
    </select>

    <!-- From / To -->
    <input type="date" class="form-control form-control-sm form-select form-select-sm" name="start_date" id="id_start_date"
           value="{{ request.GET.start_date }}" title="From">
    <input type="date" class="form-control form-control-sm form-select form-select-sm" name="end_date" id="id_end_date"
           value="{{ request.GET.end_date }}" title="To">

    <!-- Actions -->
    <button class="btn btn-secondary btn-sm action-btn apply-btn" type="submit" title="Apply">
      <i class="fas fa-filter"></i><span class="btn-text ms-1">Apply</span>
    </button>
    <a class="btn btn-outline-secondary btn-sm action-btn clear-btn" href="?" title="Clear">
      <i class="fas fa-undo"></i><span class="btn-text ms-1">Clear</span>
    </a>
  </div>
</form>

<div class="table-responsive">
  {# IMPORTANT: This expects the updated ExpenseTable (server-side renders mobile lines) #}
  {% render_table table %}
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ========= Auto-submit: Period, dates, Property, Unit, Category ========= */
(function(){
  const form = document.getElementById('expense-filter-form');
  if (!form) return;
  const submit = () => (form.requestSubmit ? form.requestSubmit() : form.submit());
  ['id_period','id_start_date','id_end_date','id_property','id_unit','id_category']
    .forEach(id => document.getElementById(id)?.addEventListener('change', submit));
})();

/* ========= Period → Dates (and auto-submit) ========= */
(function(){
  const periodSel = document.getElementById('id_period');
  const start = document.getElementById('id_start_date');
  const end = document.getElementById('id_end_date');
  const form = document.getElementById('expense-filter-form');

  function fmtLocal(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`;}
  function sow(d){const c=new Date(d);const day=(c.getDay()+6)%7;c.setDate(c.getDate()-day);return c;}
  function eow(d){const s=sow(d);const e=new Date(s);e.setDate(s.getDate()+6);return e;}
  function som(d){return new Date(d.getFullYear(), d.getMonth(), 1);}
  function eom(d){return new Date(d.getFullYear(), d.getMonth()+1, 0);}
  function soy(d){return new Date(d.getFullYear(),0,1);}
  function eoy(d){return new Date(d.getFullYear(),11,31);}

  periodSel?.addEventListener('change', () => {
    const now = new Date(); let s='', e='';
    switch(periodSel.value){
      case 'today': s=e=fmtLocal(now); break;
      case 'yesterday': {const y=new Date(); y.setDate(now.getDate()-1); s=e=fmtLocal(y); break;}
      case 'this_week': s=fmtLocal(sow(now)); e=fmtLocal(eow(now)); break;
      case 'last_week': {const n=new Date(); n.setDate(n.getDate()-7); s=fmtLocal(sow(n)); e=fmtLocal(eow(n)); break;}
      case 'this_month': s=fmtLocal(som(now)); e=fmtLocal(eom(now)); break;
      case 'last_month': {const d=new Date(now.getFullYear(), now.getMonth()-1, 1); s=fmtLocal(som(d)); e=fmtLocal(eom(d)); break;}
      case 'this_year': s=fmtLocal(soy(now)); e=fmtLocal(eoy(now)); break;
      default: s=''; e='';
    }
    start.value = s; end.value = e;
    (form.requestSubmit ? form.requestSubmit() : form.submit());
  });
})();

/* ========= Property → Unit cascade (populate + auto-submit) ========= */
(function(){
  const propertySel = document.getElementById('id_property');
  const unitSel = document.getElementById('id_unit');
  const form = document.getElementById('expense-filter-form');
  const unitsByProp = {{ units_by_property_json|default:"{}"|safe }};

  function populateUnits(){
    const pid = propertySel.value;
    unitSel.innerHTML = '';
    if(!pid){ unitSel.disabled = true; return; }
    const allOpt = document.createElement('option');
    allOpt.value = ''; allOpt.textContent = 'All units';
    unitSel.appendChild(allOpt);
    (unitsByProp[pid] || []).forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id; opt.textContent = u.label;
      if ("{{ request.GET.unit|default_if_none:'' }}" === String(u.id)) opt.selected = true;
      unitSel.appendChild(opt);
    });
    unitSel.disabled = false;
  }

  if (propertySel) {
    propertySel.addEventListener('change', () => { populateUnits(); (form.requestSubmit ? form.requestSubmit() : form.submit()); });
    unitSel.addEventListener('change', () => (form.requestSubmit ? form.requestSubmit() : form.submit()));
    populateUnits();
  }
})();
</script>
<script>
/* ========= Move/clone Receipt link into Actions on small screens ========= */
(function(){
  const table = document.querySelector('.table-responsive table');
  if (!table) return;

  function injectMobileReceiptButtons(){
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const receiptCell = row.querySelector('td.col-receipt a, td.col-receipt button, td.col-receipt .btn'); // tolerate link or button
      const actionsCell = row.querySelector('td.col-actions');

      if (!receiptCell || !actionsCell) return;
      // Avoid duplicates if this runs more than once
      if (actionsCell.querySelector('.receipt-mobile-btn')) return;

      const href = receiptCell.getAttribute('href') || '#';
      const isLink = receiptCell.tagName.toLowerCase() === 'a';

      const btn = document.createElement(isLink ? 'a' : 'button');
      btn.className = 'btn btn-outline-secondary btn-sm action-btn receipt-mobile-btn d-inline d-md-none';
      btn.title = 'Receipt';
      btn.setAttribute('aria-label', 'Open receipt');

      if (isLink) {
        btn.href = href;
        // preserve target if present
        const tgt = receiptCell.getAttribute('target');
        if (tgt) btn.setAttribute('target', tgt);
        else btn.setAttribute('target', '_blank');
        // rel for security
        btn.setAttribute('rel', 'noopener noreferrer');
      } else {
        // If your receipt is a button (e.g., triggers modal), clone its click behavior
        btn.addEventListener('click', e => receiptCell.dispatchEvent(new MouseEvent('click', {bubbles:true})));
      }

      // Use Bootstrap Icons (you already use `bi bi-plus`)
      btn.innerHTML = '<i class="bi bi-receipt"></i>';

      // Put the receipt button at the start of actions for visibility
      actionsCell.prepend(btn);
    });
  }

  // Run once on load
  injectMobileReceiptButtons();

  // If your table re-renders via pagination/filtering (server-side), re-run on DOM changes:
  const observer = new MutationObserver(() => injectMobileReceiptButtons());
  observer.observe(table.tBodies[0], { childList: true, subtree: true });
})();


</script>
<style>
:root{
  /* Large (≥ md) */
  --w-sn-lg:34px;
  --w-prop-lg:120px; 
  --w-desc-lg:180px; 
  --w-date-lg:120px;
  --w-amt-lg:120px; 
  --w-receipt-lg:30px; 
  --w-actions-lg:160px; 
  --w-distributed-lg:30px;
  --fs-table-lg:12px;

  /* Small (< md) */
  --w-sn-sm:12px; 
  --w-prop-sm:80px; 
  --w-desc-sm:80px; 
  --w-when-sm:80px;
  --w-receipt-sm:10px; 
  --w-actions-sm:80px; 
  --fs-table-sm:10px;

  /* Filters */
  --filter-gap:.35rem; --filter-row-h:1.6rem; --filter-row-h-sm:1.6rem;
  --filter-input-font:.78rem; --filter-input-font-sm:.58rem;
  --filter-input-pad-y:.05rem; --filter-input-pad-x:.45rem;
  --head-bottom:.5rem;
}

/* Heading spacing */
.d-flex.justify-content-between.align-items-center.mb-4{ margin-bottom:var(--head-bottom)!important; }
.filters-card{ margin-top:0!important; padding:.4rem .6rem; }

/* ====== FILTERS ====== */
.filters-card{ padding:.5rem .75rem; }

/* Desktop/tablet: keep everything on ONE row */
@media (min-width:768px){
  .filters-grid{
    display:flex; align-items:center; gap:.5rem; flex-wrap:nowrap; overflow-x:auto;
  }
}

/* Phones: 3 rows: (1) property/unit/category (2) period/from/to (3) apply/clear */
@media (max-width:767.98px){
  .filters-grid{
    display:grid; gap:var(--filter-gap);
    grid-template-columns: repeat(3, minmax(0, 1fr));
    grid-template-areas:
      "property  unit      category"
      "period    start     end"
      "apply     clear     .";
    grid-auto-rows: var(--filter-row-h);
  }
  #id_property   { grid-area: property; }
  #id_unit       { grid-area: unit; }
  #id_category   { grid-area: category; }
  #id_period     { grid-area: period; }
  #id_start_date { grid-area: start; }
  #id_end_date   { grid-area: end; }
  .apply-btn     { grid-area: apply; width:100%; }
  .clear-btn     { grid-area: clear; width:100%; }

  .filters-grid .form-select,
  .filters-grid .form-control{
    height:var(--filter-row-h);
    font-size:var(--filter-input-font);
    padding:var(--filter-input-pad-y) var(--filter-input-pad-x);
    line-height:1.2;
  }
}

/* ====== TABLE BASE ====== */
.table-responsive table th,
.table-responsive table td{ vertical-align:middle; }

/* Desktop widths */
@media (min-width:768px){
  .table-responsive th.col-desc,
  .table-responsive td.col-desc{
    width:var(--w-desc-lg); max-width:var(--w-desc-lg); overflow:hidden;
  }
  .table-responsive th.col-actions,
  .table-responsive td.col-actions{ width:var(--w-actions-lg); }
  .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{ width:var(--w-distributed-lg); }
  .table-responsive th.col-distributed,
  .table-responsive td.col-distributed{ width:var(--w-distributed-lg); }

  /* Clamp the desktop description (that's the span visible on ≥ md) */
  td.col-desc > span.d-md-inline{
    display:block;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
}

/* Phones widths */
@media (max-width:767.98px){
    .table-responsive table{
    table-layout: fixed;     /* critical for ellipsis to work */
    width: 100%;
  }

  .table-responsive .col-sn{ width:var(--w-sn-sm); min-width:var(--w-sn-sm); }
  .table-responsive .col-property{ min-width:var(--w-prop-sm); }
  .table-responsive th.col-desc,
  .table-responsive td.col-desc{
    width: var(--w-desc-sm) !important;
    max-width: var(--w-desc-sm) !important;
    overflow: hidden; /* defensive */
  }

  td.col-desc .desc-mobile-cat .rt-cat,
  td.col-desc .desc-mobile-desc{
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
  }
  
  .table-responsive .col-when{ width:var(--w-when-sm); }
  .table-responsive .col-actions{ width:var(--w-actions-sm); }

  /* Hide dedicated Receipt column ONLY on phones */
  .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{ display:none!important; }

  /* Description (mobile layout): clamp both lines to one with ellipsis */
  td.col-desc .desc-mobile-cat .rt-cat,
  td.col-desc .desc-mobile-desc{
    display:block;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    width:100%;
  }

  /* Actions (phones): SHOW TEXT ONLY for all buttons EXCEPT Receipt.
     Keep Receipt icon-only. */


  .col-actions .receipt-mobile-btn i{ display:inline!important; }        /* keep receipt icon */
  .col-actions .receipt-mobile-btn .btn-text{ display:none!important; }  /* hide receipt text */

  .col-actions .btn{ padding:2px 4px; }
}

/* Generic desktop text clamping for any other long cells you might add */


/* ---------- Global table font sizes (tweak the variables) ---------- */
:root{
  --fs-table-lg: 14px;   /* desktop/tablet font size */
  --fs-table-sm: 9px;   /* phone font size */
  --w-actions-sm: 110px; /* give phones a bit more room for 2x2 icons */
}

/* Apply font sizes */
@media (min-width: 768px){
  .table-responsive table th,
  .table-responsive table td{ font-size: var(--fs-table-lg); }
}
@media (max-width: 767.98px){
  .table-responsive table th,
  .table-responsive table td{ font-size: var(--fs-table-sm); }

  .col-desc{ overflow:hidden; }

.col-actions .btn .btn-label{ display: none !important; }  /* ✅ valid */

  .col-actions .btn i,
  .col-actions .btn svg{
    display: inline-block !important;         /* ensure icons show */
  }
  .col-actions .btn{ padding: 1px 1px; gap: 0; }
}

/* ---------- Actions cell padding (top/bottom) ---------- */
@media (min-width: 768px){
  td.col-actions{ padding-top: 6px; padding-bottom: 6px; }
}
@media (max-width: 767.98px){
  td.col-actions{ padding-top: 1px; padding-bottom: 1px; }
}

/* ---------- Actions buttons: padding + gap (desktop) ---------- */
@media (min-width: 768px){
  .actions-wrap{
    display: flex; align-items: center; gap: .35rem;   /* desktop gap */
  }
  .col-actions .btn{ padding: 4px 8px; }               /* desktop button padding */
}

/* ---------- Phones: icon-only, 2x2 grid, custom gaps ---------- */
@media (max-width: 767.98px){
  /* 1) Make the actions wrap a 2-column grid */
  .actions-wrap{
    display: grid !important;
    grid-template-columns: repeat(2, auto);  /* 2 buttons per row */
    grid-auto-rows: auto;
    column-gap: .05rem;                      /* horizontal gap between buttons */
    row-gap: .050rem;                         /* vertical gap between rows */
    justify-content: center;                 /* center the grid inside the cell */
    align-items: center;
    margin-top: 1px;                         /* extra space above/below the grid */
    margin-bottom: 1px;
  }

  /* 2) Make buttons icon-only on phones */
  .col-actions .btn .btn-text{ display: none !important; }
  .col-actions .btn i, .col-actions .btn svg{ display: inline-block !important; }

  /* 3) Compact phone padding for each button */
  .col-actions .btn{ padding: 1px 1px; }

  /* 4) Force ordering: put Receipt in the first row, first slot */
  .actions-wrap .btn-receipt{ order: 0; }
  .actions-wrap .btn-view   { order: 1; }
  .actions-wrap .btn-edit   { order: 2; }
  .actions-wrap .btn-delete { order: 3; }

  /* If you ever want different order, just change these numbers. */
}

/* Desktop/tablet spacing */
@media (min-width: 768px){
  .actions-wrap{
    display: flex;               /* single row */
    align-items: center;
    gap: .35rem;                 /* gap between buttons on desktop */
  }
  .action-btn{ padding: 4px 8px; }   /* button padding desktop */
  td.col-actions{ padding-top: 1px; padding-bottom: 1px; } /* cell top/bottom */
}

/* Phones: 2×2 grid, icon-only, compact spacing */
@media (max-width: 767.98px){
  /* force grid even if .d-flex is present somewhere */
  .actions-wrap{
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 per row */
    column-gap: .05rem;                                /* horizontal gap */
    row-gap: .05rem;                                   /* vertical gap */
    justify-items: center;
    align-items: center;
    margin-top: 1px; margin-bottom: 1px;               /* top/bottom space inside cell */
  }

  /* icon-only */
  .action-btn .btn-text{ display: none !important; }
  .action-btn i, .action-btn svg{ display: inline-block !important; }

  /* compact button padding on phones */
  .action-btn{ padding: 4px !important; width: 100%; justify-content: center; }

  /* make sure the Actions cell itself can wrap */
  td.col-actions, th.col-actions{ white-space: normal !important; }

  /* order: first row = Receipt + View; second row = Edit + Delete; rest follow */
  .actions-wrap .btn-receipt{ order: 0; }
  .actions-wrap .btn-view   { order: 1; }
  .actions-wrap .btn-edit   { order: 2; }
  .actions-wrap .btn-delete { order: 3; }

  /* OPTIONAL: if you want ONLY the first four on phones, hide the rest: */
  /* .actions-wrap .action-btn:nth-child(n+5){ display:none !important; } */
}

/* =========================
   Phones (≤ 767.98px)
   ========================= */
@media (max-width: 767.98px){

  /* A) Make fixed layout + shrink cell paddings so widths actually fit */
  .table-responsive table{
    table-layout: fixed;
    width: 100%;
  }
  .table-responsive table th,
  .table-responsive table td{
    padding-left: 4px;
    padding-right: 4px;
    font-size: var(--fs-table-sm, 10px);
  }

  /* B) Override any text-nowrap on property/actions so they can wrap grid/content */
  td.col-property, th.col-property,
  td.col-actions, th.col-actions{
    white-space: normal !important;
  }

  /* C) Set conservative widths that fit ~360px devices (content width only; padding is extra) */
  :root{
    --w-sn-sm: 10px;
    --w-prop-sm: 82px;     /* property */
    --w-desc-sm: 90px;     /* description (category + desc lines) */
    --w-when-sm: 80px;     /* date/amount combined */
    --w-actions-sm: 76px;  /* actions grid with 2 icons per row */
  }

  .table-responsive th.col-sn, .table-responsive td.col-sn{ width: var(--w-sn-sm); min-width: var(--w-sn-sm); }
  .table-responsive th.col-property, .table-responsive td.col-property{ width: var(--w-prop-sm); }
  .table-responsive th.col-desc, .table-responsive td.col-desc{
    width: var(--w-desc-sm) !important;
    max-width: var(--w-desc-sm) !important;
    overflow: hidden;
  }
  .table-responsive th.col-when, .table-responsive td.col-when{ width: var(--w-when-sm); }
  .table-responsive th.col-actions, .table-responsive td.col-actions{ width: var(--w-actions-sm); }

  /* D) Clamp text inside property + description (one line, ellipsis) */
  td.col-property a{
    display:block;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    width:100%;
  }
  td.col-desc .desc-mobile-cat .rt-cat,
  td.col-desc .desc-mobile-desc{
    display:block;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    width:100%;
  }

  /* Hide the standalone Receipt column entirely */
  .table-responsive th.col-receipt,
  .table-responsive td.col-receipt{ display:none !important; }

  /* E) Actions: real 2×2 grid, icon-only, compact button vertical space, small icons */
  .actions-wrap{
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr));  /* two per row */
    column-gap: .02rem;
    row-gap: .02rem;
    justify-items: center;
    align-items: center;
    margin-top: 1px; margin-bottom: 1px;              /* space above/below the grid */
  }

  /* smaller icon size in actions */
  .actions-wrap .action-btn i,
  .actions-wrap .action-btn svg{
    font-size: 12px;          /* ↓ icon size on phones */
    line-height: 1;
  }

  /* buttons compact top/bottom padding */
  .actions-wrap .action-btn{
    padding: 1px 1px !important;   /* top/bottom = 3px, left/right = 4px */
    width: 100%;
    justify-content: center;
  }

  /* icon-only on phones */
  .actions-wrap .action-btn .btn-text{ display:none !important; }

  /* Receipt first row, then View, then Edit, then Delete */
  .actions-wrap .btn-receipt{ order: 0; }
  .actions-wrap .btn-view   { order: 1; }
  .actions-wrap .btn-edit   { order: 2; }
  .actions-wrap .btn-delete { order: 3; }

  /* If there are >4 buttons on some rows, they will naturally wrap to a 3rd row.
     To hard-limit to 4 buttons on phones, uncomment:
     .actions-wrap .action-btn:nth-child(n+5){ display:none !important; }
  */
}

/* Phones (<= 767.98px): make all action icons tiny & tight,
   and make sure the Receipt button obeys the same rules */
@media (max-width: 767.98px){

  /* 2x2 grid that only takes as much width as the icons need */
  .actions-wrap{
    display: grid !important;
    grid-template-columns: repeat(2, max-content); /* two per row, size to icon */
    column-gap: .08rem;   /* tiny horizontal gap */
    row-gap: .08rem;      /* tiny vertical gap */
    justify-content: center;
    align-items: center;
    margin-top: 1px;
    margin-bottom: 1px;
  }

  /* icon-only */
  .actions-wrap .action-btn .btn-text,
  .actions-wrap .action-btn .btn-label{
    display: none !important;
  }

  /* remove button chrome + padding for ALL action buttons */
  .actions-wrap .action-btn{
    padding: 0 2px !important;
    margin: 0 !important;
    border: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
    width: auto !important;
    min-width: 0 !important;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* normalize icon size across FA and Bootstrap Icons */
  .actions-wrap .action-btn i,
  .actions-wrap .action-btn svg{
    font-size: 11px !important;
    width: 11px; height: 11px;   /* helps some SVGs */
  }

  /* make sure the Receipt button doesn't keep any special padding */
  .actions-wrap .btn-receipt{
    padding: 0 1px !important;
    border: 0 !important;
    background: transparent !important;
  }

  /* ordering: row1 = Receipt + View; row2 = Edit + Delete */
  .actions-wrap .btn-receipt{ order: 0; }
  .actions-wrap .btn-view   { order: 1; }
  .actions-wrap .btn-edit   { order: 2; }
  .actions-wrap .btn-delete { order: 3; }
}

</style>


{% endblock %}

{% block extra_css %}

{% endblock %}
