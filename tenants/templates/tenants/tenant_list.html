{% extends 'base.html' %}
{% load static humanize %}
{% load payments_url_helpers %}
{% load tenants_url_helpers %}

{% block content %}
<div class="container-fluid grid-tight">

    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="h5 mb-0 d-inline">Tenants</h1>
            {% if is_paginated %}
            <div class="d-flex justify-content-between align-items-center">
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                Previous
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                Next 
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="text-muted small">
                    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="d-flex align-items-center">
            <a href="{% url 'tenants:tenant_create' %}" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-plus"></i> Add Tenants
            </a>
        </div>    
        <div class="btn-group me-2">
            <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download"></i> Export
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&export=pdf">
                    <i class="fas fa-file-pdf text-danger me-1"></i> PDF
                </a></li>
                <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&export=csv">
                    <i class="fas fa-file-csv text-success me-1"></i> CSV
                </a></li>
                <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&export=xlsx">
                    <i class="fas fa-file-excel text-success me-1"></i> Excel
                </a></li>
            </ul>
            </div>   
        
            
           
            
            
        </div>
    </div>

    <form method="get" id="filter-form" class="mb-2">
        <div class="filters-grid">
            <div class="fg name">
            <select id="tenant-filter" name="tenant" class="form-control form-control-sm select2"
                    data-placeholder="All Tenants">
                <option value="">All Tenants</option>
                {% for t in all_tenants %}
                <option value="{{ t.id }}" {% if request.GET.tenant == t.id|stringformat:"s" %}selected{% endif %}>
                    {{ t.first_name }} {{ t.last_name }}
                </option>
                {% endfor %}
            </select>
            </div>

            <div class="fg phone">
            <input type="text" name="phone" class="form-control form-control-sm" placeholder="Phone"
                    value="{{ request.GET.phone }}">
            </div>

            <div class="fg property">
            <select name="property" class="form-control form-control-sm" id="property-select">
                <option value="">All Properties</option>
                {% for property in properties %}
                <option value="{{ property.id }}" {% if request.GET.property == property.id|stringformat:"s" %}selected{% endif %}>
                    {{ property.property_name }}
                </option>
                {% endfor %}
            </select>
            </div>

            <div class="fg unit">
            <select name="unit" class="form-control form-control-sm" id="unit-select">
                <option value="">All Units</option>
                {% for unit in all_units %}
                <option value="{{ unit.id }}" {% if request.GET.unit == unit.id|stringformat:"s" %}selected{% endif %}>
                    {{ unit.unit_number }}
                </option>
                {% endfor %}
            </select>
            </div>

            <div class="fg actions">
            <div class="d-flex align-items-center gap-1 w-100">
                <div class="form-check me-2 flex-shrink-0">
                <input type="checkbox" name="show_inactive" class="form-check-input" id="show_inactive"
                        {% if request.GET.show_inactive %}checked{% endif %}>
                <label class="form-check-label ms-1" for="show_inactive">Show Inactive</label>
                </div>
                <button type="submit" class="btn btn-primary btn-sm ms-auto">Filter</button>
                <a href="{% url 'tenants:tenant_list' %}" class="btn btn-secondary btn-sm">Reset</a>
            </div>
            </div>
        </div>
        </form>


    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm">
            <thead class="thead-light">
            <tr>
                <th class="col-sn" style="width:2%">#</th>
                <th class="col-photo" style="width:12%">Photo</th>
                <th class="col-tenant" style="width:14%">Tenant Info</th>
                <th class="col-contact" style="width:10%">Contact/Email</th>
                <th class="col-emergency" style="width:8%">Emergency</th>
                <th class="col-cnic-front" style="width:6%">CNIC Front</th>
                <th class="col-cnic-back" style="width:6%">CNIC Back</th>
                <th class="col-address" style="width:8%">Address</th>
                <th class="col-notes" style="width:8%">Notes</th>
                <th class="col-lease" style="width:11%">Lease & Payment</th>
                <th class="col-actions" style="width:19%">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for tenant in tenants %}
            {% with lease=tenant.current_lease %}
            <tr>
            <td>{{ page_obj.start_index|add:forloop.counter0 }}</td>

            {# --- PHOTO w/ CNIC thumbnails underneath (stacked) --- #}
            <td class="p-0 col-photo">
                <div class="photo-stack">
                <div class="photo-main">
                    {% if tenant.photo %}
                    <a href="{{ tenant.photo.url }}" data-toggle="lightbox" class="d-block">
                        <img src="{{ tenant.photo.url }}" class="img-main" alt="Photo">
                    </a>
                    {% else %}
                    <div class="bg-secondary d-flex align-items-center justify-content-center img-main">
                        <i class="fas fa-user text-white fa-lg"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="photo-cnic">
                    {% if tenant.cnic_front %}
                    <a href="{{ tenant.cnic_front.url }}" data-toggle="lightbox" class="d-block">
                        <img src="{{ tenant.cnic_front.url }}" class="img-cnic" alt="CNIC Front">
                    </a>
                    {% endif %}
                    {% if tenant.cnic_back %}
                    <a href="{{ tenant.cnic_back.url }}" data-toggle="lightbox" class="d-block">
                        <img src="{{ tenant.cnic_back.url }}" class="img-cnic" alt="CNIC Back">
                    </a>
                    {% endif %}
                </div>
                </div>


            </td>

            {# --- TENANT INFO w/ contact/email moved beneath --- #}
            <td class="p-1 col-tenant">
                <a href="{% url 'tenants:tenant_update' tenant.id %}" class="text-primary d-block">
                <strong>{{ tenant.first_name }}</strong>
                </a>
                <span class="text-muted xsmall d-block">
                {{ tenant.number_of_family_member }} Family ‚Äì {{ tenant.get_gender_display }}
                </span>

                {# Contact/Email lives here (always), but original column is hidden on small #}
                <div class="tenant-contact-inline">
                <div class="xsmall">{{ tenant.phone }}</div>
                {% if tenant.email %}<div class="xsmall text-muted">{{ tenant.email }}</div>{% endif %}
                </div>
            </td>

            {# -- Original columns (visible ‚â• md). Hidden on small and represented by icons -- #}
            <td class="p-1 xsmall col-contact d-none d-md-table-cell">
                {{ tenant.phone }}
                <span class="text-muted xsmall d-block">{{ tenant.email }}</span>
            </td>
            <td class="col-emergency d-none d-md-table-cell" style="font-size:0.7rem">
                {{ tenant.emergency_contact_name }}<br>{{ tenant.emergency_contact_phone }}
            </td>
            <td class="p-0 col-cnic-front d-none d-md-table-cell">
                {% if tenant.cnic_front %}
                <a href="{{ tenant.cnic_front.url }}" data-toggle="lightbox" class="d-block">
                    <img src="{{ tenant.cnic_front.url }}" style="width:100px;height:75px;object-fit:contain;" alt="CNIC Front">
                </a>
                {% endif %}
            </td>
            <td class="p-0 col-cnic-back d-none d-md-table-cell">
                {% if tenant.cnic_back %}
                <a href="{{ tenant.cnic_back.url }}" data-toggle="lightbox" class="d-block">
                    <img src="{{ tenant.cnic_back.url }}" style="width:100px;height:75px;object-fit:contain;" alt="CNIC Back">
                </a>
                {% endif %}
            </td>
            <td class="col-address d-none d-md-table-cell" style="font-size:0.7rem">
                {{ tenant.address|default:"-"|truncatechars:40 }}
            </td>

            <td class="col-notes" style="font-size:0.7rem">
                {{ tenant.notes|default:"-"|truncatechars:40 }}
            </td>

            <td class="p-1 small col-lease" style="font-size:0.7rem">
            {% if lease %}
                <div class="d-flex flex-column">
                <a href="{% url 'leases:lease_detail' lease.pk %}" class="link-primary text-decoration-none">
                    <span><strong>{{ lease.unit.property.property_name }} - {{ lease.unit.unit_number }}</strong></span>
                </a>

                <span>
                    Ends:
                    <span class="{% if lease.is_ending_soon %}text-danger{% endif %}">
                    {{ lease.end_date|date:"Y-m-d" }}
                    </span>
                </span>

                <span>Monthly: {{ lease.total_payment|intcomma }}</span>

                <span class="{% if lease.get_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                    Balance: {{ lease.get_balance|intcomma }}
                </span>

                {# üîª NEW: Security Deposit Balance #}
                {% with sec=lease.security_due %}
                    <span class="{% if sec > 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
                    Security:
                    {% if sec > 0 %}
                        {{ sec|intcomma }}
                    {% else %}
                        Paid
                    {% endif %}
                    </span>
                {% endwith %}
                {# üî∫ NEW END #}
                </div>
            {% else %}
                <span class="text-muted">No active lease</span>
            {% endif %}
            </td>


            {# ACTIONS: grid w/ 2 icons per row on small, regular buttons ‚â• md #}
            <td class="p-1 col-actions">

                <div class="d-none d-md-flex flex-wrap">
                    <a href="{% url 'tenants:tenant_detail' tenant.id %}" class="btn btn-info btn-xs m-1">
                        <i class="fas fa-eye"></i><span class="ms-1">View</span>
                    </a>
                    <a href="{% url 'tenants:tenant_update' tenant.id %}" class="btn btn-primary btn-xs m-1">
                        <i class="fas fa-edit"></i><span class="ms-1">Edit</span>
                    </a>
                    {% if lease %}
                        <a href="{% url 'leases:lease_ledger_by_pk' lease.id %}" class="btn btn-secondary btn-xs m-1">
                        <i class="fas fa-file-invoice-dollar"></i><span class="ms-1">Ledger</span>
                        </a>
                        <a href="{% url 'payments:payment_create' %}?lease={{ lease.id }}" class="btn btn-success btn-xs m-1">
                        <i class="fas fa-money-bill-wave"></i><span class="ms-1">Pay</span>
                        </a>
                        <button
                            type="button"
                            class="btn btn-sm btn-success"
                            onclick="sendWhatsAppReminder(
                                '{{ tenant.phone|default_if_none:""|escapejs }}',
                                '{{ tenant.first_name|default_if_none:""|escapejs }}',
                                '{{ tenant.last_name|default_if_none:""|escapejs }}',
                                '{{ lease.unit.property.property_name|default_if_none:""|escapejs }}',
                                '{{ lease.unit.unit_number|default_if_none:""|escapejs }}',
                                '{{ lease.get_balance|default_if_none:0 }}',
                                '{{ lease.security_due|default_if_none:0 }}'
                            )">
                            WhatsApp
                            </button>

                    {% endif %}
                    <a href="{% url 'tenants:tenant_delete' tenant.id %}" class="btn btn-danger btn-xs m-1">
                        <i class="fas fa-trash"></i><span class="ms-1">Delete</span>
                    </a>
                    </div>

                <div class="actions-grid d-md-none">
                    <a href="{% url 'tenants:tenant_detail' tenant.id %}" class="icon-btn text-info"  title="View"  data-bs-toggle="tooltip" aria-label="View">
                        <i class="fas fa-eye"></i>
                    </a>

                    <a href="{% url 'tenants:tenant_update' tenant.id %}" class="icon-btn text-primary" title="Edit"  data-bs-toggle="tooltip" aria-label="Edit">
                        <i class="fas fa-edit"></i>
                    </a>

                    {% if lease %}
                        <a href="{% url 'leases:lease_ledger_by_pk' lease.id %}" class="icon-btn text-secondary" title="Ledger" data-bs-toggle="tooltip" aria-label="Ledger">
                        <i class="fas fa-file-invoice-dollar"></i>
                        </a>

                        <a href="{% url 'payments:payment_create' %}?lease={{ lease.id }}" class="icon-btn text-success" title="Pay" data-bs-toggle="tooltip" aria-label="Pay">
                        <i class="fas fa-money-bill-wave"></i>
                        </a>

                        <button
                            type="button"
                            class="btn btn-sm btn-success"
                            onclick="sendWhatsAppReminder(
                                '{{ tenant.phone|default_if_none:""|escapejs }}',
                                '{{ tenant.first_name|default_if_none:""|escapejs }}',
                                '{{ tenant.last_name|default_if_none:""|escapejs }}',
                                '{{ lease.unit.property.property_name|default_if_none:""|escapejs }}',
                                '{{ lease.unit.unit_number|default_if_none:""|escapejs }}',
                                '{{ lease.get_balance|default_if_none:0 }}',
                                '{{ lease.security_due|default_if_none:0 }}'
                            )">
                            WhatsApp
                            </button>


                    {% endif %}

                    <a href="{% url 'tenants:tenant_delete' tenant.id %}" class="icon-btn text-danger" title="Delete" data-bs-toggle="tooltip" aria-label="Delete">
                        <i class="fas fa-trash"></i>
                    </a>
                    </div>

            </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
            <td colspan="11" class="text-center py-2 xxsmall">No tenants found matching your criteria</td>
            </tr>
            {% endfor %}
            </tbody>

        </table>
    </div>

    {% if is_paginated %}
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        Previous
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        Next
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        <div class="text-muted small">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


<style>
    /* Compact table styling */
    .table-sm td, .table-sm th {
        padding: 0.2rem;
        font-size: 0.8rem;
        vertical-align: middle;
    }
    
    .small {
        font-size: 0.8rem;
    }
    
    .xsmall {
        font-size: 0.7rem;
        color: #666;
    }
    
    .xxsmall {
        font-size: 0.6rem;
        color: #666;
    }
    
    /* Buttons */
    .btn-xs {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        line-height: 1.2;
        border-radius: 0.2rem;
    }
    
    /* Images */
    .table img {
        max-height: 40px;
        width: 100%;
        object-fit: cover;
    }
    
    /* Select2 dropdown */
    .select2-container .select2-selection--single {
        height: 30px !important;
        font-size: 0.8rem;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 28px;
    }
    
    /* Form controls */
    .form-control-sm {
        height: calc(1.2em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* Pagination */
    .pagination-sm .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* Photo column */
    td.p-0 {
        padding: 0 !important;
    }
    
    /* Action buttons */
    .btn-group-vertical .btn {
        margin-bottom: 0.1rem;
    }
    
    /* Unit select width */
    #unit-select {
        width: 120px !important;
    }
    
    /* Disabled unit select */
    #unit-select:disabled {
        background-color: #e9ecef;
        opacity: 1;
    }
    
    /* Button spacing */
    .btn-group, .btn {
        margin-right: 0.5rem;
    }
    
    /* Dropdown fix */
    .dropdown-menu {
        min-width: 7rem;
    }


  /* ---------- Tunables ---------- */
  :root{
    /* image sizes */
    --photo-main-w: 100px;
    --photo-main-h: 100px;
    --cnic-w: 46px;   /* tweak CNIC thumb size */
    --cnic-h: 34px;
    --photo-gap: 6px;

    /* table column widths on small (applied via media rules) */
    --w-col-photo: 110px;
    --w-col-tenant: 60;  /* fill */
    --w-col-actions: 30px;
    --w-col-lease: 90px;

    /* action/icon controls on small */
    --icon-size: 12px;
    --icon-pad: 1px;
    --icon-gap: 1px;

    /* filters */
    --fg-gap: 6px;

    /* How many icons per row on SMALL screens (1 or 2) */
    --actions-cols: 2;


  }

  /* Keep existing compact styles you already had ‚Ä¶ */

  /* --- Photo+CNIC vertical stack --- */
  .photo-stack{ display:flex; flex-direction:column; align-items:center; gap:var(--photo-gap); padding:4px; }
  .photo-stack .img-main{
    width:var(--photo-main-w); height:var(--photo-main-h);
    object-fit:contain; object-position:center;
  }
  .photo-stack .photo-cnic{ display:flex; gap:4px; flex-wrap:wrap; justify-content:center; }
  .photo-stack .img-cnic{
    width:var(--cnic-w); height:var(--cnic-h); object-fit:contain;
  }


  /* Actions: 2 icons per row on small */
  .actions-grid{
    display:grid; gap:var(--icon-gap);
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  .actions-grid .icon-btn{ /* reuse same icon button look */
    display:flex; align-items:center; justify-content:center;
    width:100%; padding:var(--icon-pad); border:1px solid #e5e7eb; border-radius:6px; background:#fff;
  }
  .actions-grid .icon-btn i{ font-size:var(--icon-size); }

  /* Tenant contact inline (under name) */
  .tenant-contact-inline{ margin-top:2px; }

  /* --------- Filters grid (mobile-first) ---------- */
  .filters-grid{
    display:grid; gap:var(--fg-gap);
    grid-template-columns: 1fr 1fr; /* mobile: two columns => (name+phone), (property+unit), then full-row actions */
    grid-template-areas:
      "name phone"
      "property unit"
      "actions actions";
  }
  .filters-grid .fg.name{ grid-area:name; }
  .filters-grid .fg.phone{ grid-area:phone; }
  .filters-grid .fg.property{ grid-area:property; }
  .filters-grid .fg.unit{ grid-area:unit; }
  .filters-grid .fg.actions{ grid-area:actions; }

  /* ---------- Small screens: ‚â§ 380px explicitly covers 360px ---------- */
  @media (max-width: 380px){
    /* Kill horizontal scroll by forcing key widths and hiding heavy columns */
    table{ table-layout:fixed; width:100%; }
    th.col-photo, td.col-photo{ width:var(--w-col-photo); }
    th.col-actions, td.col-actions{ width:var(--w-col-actions); }
    th.col-tenant, td.col-tenant{ width:var(--w-col-tenant); }
     th.col-lease, td.col-lease{ width:var(--w-col-lease); }


 

    /* Hide ‚Äúheavy‚Äù columns, show icons instead */
    th.col-contact, td.col-contact,
    th.col-emergency, td.col-emergency,
    th.col-cnic-front, td.col-cnic-front,
    th.col-cnic-back, td.col-cnic-back,
    th.col-notes,td.col-notes,
    th.col-address, td.col-address{
      display:none !important;
    }

    /* Show icon-grid actions; hide full button set */
    .col-actions .d-md-flex{ display:none !important; }
    .col-actions .actions-grid{ display:grid; }

    /* Tighten paddings/fonts a bit */
    .table-sm td, .table-sm th{ padding:0.25rem 0.3rem; font-size:0.58rem; }
  }

  /* ---------- ‚â• md: keep desktop/tablet normal ---------- */
  @media (min-width: 768px){

    .col-actions .actions-grid{ display:none !important; }
    .col-actions .d-md-flex{ display:flex !important; }
  }
  /* ===== MOBILE ICONS + ACTIONS TUNABLES ===== */
:root{
  /* Sizes you can tweak */
  --icon-size: 16px;      /* icon glyph size */
  --icon-pad: 4px;        /* inner padding around icon */
  --icon-gap: 6px;        /* gap between buttons */

  /* How many icons per row on SMALL screens (1 or 2) */
  --actions-cols: 1;


  /* Small column widths (keep narrow to avoid horizontal scroll) */
  --w-col-photo: 110px;
  --w-col-actions: 22px;
}

/* Ensure Font Awesome glyphs are visible in the icon squares */
.mini-icons{ display:none !important; }


/* Action icons grid on small screens */
.actions-grid{
  display:grid;
  gap:var(--icon-gap);
  grid-template-columns: repeat(var(--actions-cols), auto);
  justify-content:center; /* center icons in the column */
}

/* icon-only buttons: no white bg, no forced color */
.actions-grid .icon-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:var(--icon-pad);
  background:transparent;
  border:0;             /* remove box look */
  line-height:1;
}

/* PHOTO + CNIC stack ‚Äî slightly smaller defaults */
.photo-stack .img-main{
  width: 90px; height: 90px; /* tweak freely */
  object-fit: contain; object-position: center;
}
.photo-stack .photo-cnic .img-cnic{
  width: 44px; height: 32px; /* tweak CNIC thumbs here */
}

/* Kill horizontal scroll on very small screens (incl. 360px) */
@media (max-width: 380px){
  table{ table-layout: fixed; width: 100%; }

  th.col-photo, td.col-photo{ width: var(--w-col-photo); }
  th.col-actions, td.col-actions{ width: var(--w-col-actions); }



  /* Make action grid active; hide full buttons */
  th.col-actions, td.col-actions{ width: var(--w-col-actions); }
  .col-actions .d-md-flex{ display: none !important; }
  .col-actions .actions-grid{ display: grid; }



  /* Reduce table padding a touch more */
  .table-sm td, .table-sm th{
    padding: 0.22rem 0.28rem;
    font-size: 0.76rem;
  }

  
  /* === SMALL SCREEN: make Actions narrow (1 icon per line) and Lease wider === */
@media (max-width: 380px){
  /* knobs you can tweak */
  :root{
    --w-col-sn:15px;
    --w-col-actions: 52px;   /* shrink Actions; try 48‚Äì64px */
    --w-col-lease:  40%;     /* give Lease & Payment more room (percent works well) */
    --icon-size:    14px;    /* icon glyph size */
    --icon-pad:     2px;     /* tap padding */
    --icon-gap:     4px;     /* gap between icons */
  }

  /* enforce column widths */
  th.col-actions, td.col-actions { width: var(--w-col-actions) !important; }
  th.col-lease,   td.col-lease   { width: var(--w-col-lease)  !important; }
  th.col-sn,   td.col-sn   { width: var(--w-col-sn)  !important; }

  /* force 1 icon per row and remove any white boxes */
  .actions-grid{
    grid-template-columns: 1fr !important;     /* one icon per line */
    gap: var(--icon-gap) !important;
    justify-content: center !important;
  }
  .actions-grid .icon-btn{
    padding: var(--icon-pad) !important;
    background: transparent !important;
    border: 0 !important;
    width: auto !important;                    /* don't stretch */
    line-height: 1;
  }
  .actions-grid .icon-btn i{
    font-size: var(--icon-size) !important;
    color: currentColor !important;            /* keep your text-* colors */
  }
}
@media (min-width: 992px) {
  .payment-list-dense th.col-tenant,
  .payment-list-dense td.col-tenant {
    max-width: var(--lg-tenant-w, 20rem);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ‚úÖ Narrower tenant filter on big screens */
  #id_tenant { width: 10rem !important; }
}
}

</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// Define the function in global scope before DOM ready
// WhatsApp reminder function - working version from lease template
// WhatsApp reminder function - extended with security deposit balance
function sendWhatsAppReminder(
    phone,
    firstName,
    lastName,
    propertyName,
    unitNumber,
    balance,
    secBalance
) {
    try {
        if (!phone) {
            alert("No phone number provided");
            return;
        }

        const cleaned = phone.toString().replace(/\D/g, '');
        const formatted = cleaned.startsWith('0')
            ? '92' + cleaned.slice(1)
            : cleaned.startsWith('92')
                ? cleaned
                : '92' + cleaned;

        const numericBalance = parseFloat(balance || '0') || 0;
        const numericSec     = parseFloat(secBalance || '0') || 0;

        const formattedBalance = numericBalance.toLocaleString('en-PK', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        const formattedSec = numericSec.toLocaleString('en-PK', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        let message =
            `Dear ${firstName} ${lastName},\n\n` +
            `Payment Reminder:\n` +
            `Property: ${propertyName}\n` +
            `Unit: ${unitNumber}\n` +
            `Balance Due: Rs. ${formattedBalance}`;

        // üî¥ Security line: show balance if > 0, else ‚ÄúPaid‚Äù
        if (numericSec > 0) {
            message += `\nSecurity Deposit Balance: Rs. ${formattedSec}`;
        } else {
            message += `\nSecurity Deposit: Paid`;
        }

        message += `\n\nPlease pay at your earliest convenience.`;

        window.open(
            `https://wa.me/${formatted}?text=${encodeURIComponent(message)}`,
            '_blank'
        );
    } catch (error) {
        console.error("WhatsApp error:", error);
        alert("Failed to send WhatsApp: " + error.message);
    }
}

// Make it globally available
window.sendWhatsAppReminder = sendWhatsAppReminder;


document.addEventListener('DOMContentLoaded', function () {
  const $form      = $('#filter-form');
  const $tenantSel = $('#tenant-filter');
  const $propSel   = $('#property-select');
  const $unitSel   = $('#unit-select');
  const $inactive  = $('#show_inactive');

  // --- Select2 tenant (type to search) + UX niceties ---
  $tenantSel.select2({
    width: '100%',
    placeholder: "All Tenants",
    allowClear: true,
    minimumResultsForSearch: 0,
    selectOnClose: true
  });

  // Open on focus, and focus the search input (saves a click)
  $(document).on('focus', '#tenant-filter + .select2 .select2-selection', function () {
    $tenantSel.select2('open');
  });
  $(document).on('select2:open', () => {
    const sf = document.querySelector('.select2-container--open .select2-search__field');
    if (sf) { sf.focus(); sf.select(); }
  });

  // --- Mirror lease_list behavior: auto-submit on change --------------------
  // Checkboxes submit immediately
  $inactive.on('change', function () {
    $form.submit();
  });

  // Property change: clear tenant (server will recalc units), submit
  $propSel.on('change', function () {
    $tenantSel.val('').trigger('change');
    $form.submit();
  });

  // Unit change: clear tenant, submit
  $unitSel.on('change', function () {
    $tenantSel.val('').trigger('change');
    $form.submit();
  });

  // Tenant change: clear property + unit, submit
  $tenantSel.on('change', function () {
    if ($(this).val()) {
      $propSel.val('');
      $unitSel.val('');
    }
    $form.submit();
  });

  // Phone: press Enter to submit (no auto-submit on typing)
  $('input[name="phone"]').on('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      $form[0].submit();
    }
  });

  // (Optional) If no property selected at load, keep unit enabled; the page re-render will
  // repopulate units just like the lease page. No custom AJAX is needed here.
  // Remove any previous code that fetched /api/properties/.../units/ via $.get().
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
});
</script>


{% endblock %}