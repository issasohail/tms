{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block extra_css %}
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
{% endblock %}

{% block title %}{% if form.instance.pk %}Update{% else %}Record{% endif %} Payment{% endblock %}

{% block content %}
<div class="row g-2" id="payment-viewport">
  <!-- LEFT: Payment Form -->
  <div class="col-12 col-md-5">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center py-2">
        <h4 class="mb-0">{% if form.instance.pk %}Update{% else %}Record{% endif %} Payment</h4>
        <button class="btn btn-secondary btn-sm" type="button" onclick="history.back()">
          <i class="fas fa-arrow-left"></i> Back
        </button>
      </div>

      <div class="card-body p-2">
        <form method="post" id="paymentForm" class="compact-form">
          {% csrf_token %}

          <!-- Search Lease -->
          <div class="card mb-2" id="search-lease-card">
            <div class="card-header bg-light py-1 d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Search Lease</h6>
              <button type="button" id="resetFilters" class="btn btn-sm btn-secondary py-0 px-2">
                <i class="fas fa-undo"></i> Reset
              </button>
            </div>

            <div class="card-body p-2">
              <!-- Desktop: all in one line -->
              <div class="row g-1 align-items-end">
                <div class="col-12 col-md-4">
                  <label for="id_tenant_search" class="form-label small mb-1">Tenant</label>
                  <select name="tenant_search" id="id_tenant_search" class="form-select compact-select one-line form-select-sm">
                    <option value="">All Tenants</option>
                    {% for tenant in active_tenants %}
                      <option value="{{ tenant.id }}" {% if request.GET.tenant_search == tenant.id|stringformat:"s" %}selected{% endif %}>
                        {{ tenant.get_full_name|truncatechars:20 }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-6 col-md-3">
                  {{ form.property|as_crispy_field }}
                </div>

                <div class="col-6 col-md-3">
                  {{ form.unit|as_crispy_field }}
                </div>

                <div class="col-12 col-md-2 d-flex justify-content-md-end">
                  <div class="include-compact w-100 w-md-auto">
                    {{ form.include_inactive|as_crispy_field }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Details -->
          <div class="card mb-2" id="payment-details-card">
            <div class="card-header bg-light py-1">
              <h6 class="mb-0">Payment Details</h6>
            </div>

            <div class="card-body p-2">
              <!-- Lease picker -->
              <div class="row g-1">
                <div class="col-12">
                  <label for="id_lease" class="visually-hidden">Lease</label>
                  {{ form.lease }}
                </div>
              </div>

              <!-- Date + Amount (compact) -->
              <div class="row g-1 mt-1">
                <div class="col-6 col-md-6">
                  {{ form.payment_date|as_crispy_field }}
                </div>
                <div class="col-6 col-md-6">
                  {{ form.amount|as_crispy_field }}
                </div>
              </div>

              <hr class="my-2">

              <!-- Allocation header line: Mode + balances -->
              <div class="row g-1 align-items-end">
                <div class="col-12 col-md-5">
                  <div class="small fw-semibold mb-1">Allocation Mode</div>
                  {{ allocation_form.allocation_mode }}
                </div>

                <div class="col-6 col-md-3">
                  <div class="small text-muted mb-1">Lease Balance</div>
                  <span id="lease-balance-display" class="balance-pill">—</span>
                </div>

                <div class="col-6 col-md-4">
                  <div class="small text-muted mb-1">Security Balance</div>
                  <span id="sec-balance-display" class="balance-pill">—</span>
                </div>
              </div>

              <!-- Security Type + Lease Amount + Security Amount (one line on desktop) -->
              <div class="row g-1 align-items-end mt-1">
                <div class="col-12 col-md-4">
                  <div class="small fw-semibold mb-1">Security Type</div>
                  {{ allocation_form.security_type }}
                </div>

                <div class="col-6 col-md-4">
                  <div class="small fw-semibold mb-1">Lease Amount</div>
                  {{ allocation_form.lease_amount }}
                </div>

                <div class="col-6 col-md-4">
                  <div class="small fw-semibold mb-1">Security Amount</div>
                  {{ allocation_form.security_amount }}
                </div>
              </div>

              <hr class="my-2">

              <!-- Payment method + Ref + Notes (one line on desktop) -->
              <div class="row g-1 align-items-end">
                <div class="col-12 col-md-4">
                  {{ form.payment_method|as_crispy_field }}
                </div>
                <div class="col-12 col-md-4">
                  {{ form.reference_number|as_crispy_field }}
                </div>
                <div class="col-12 col-md-4">
                  {{ form.notes|as_crispy_field }}
                </div>
              </div>
            </div>
          </div>

          <!-- Actions (add a little space between Save/New/Print) -->
          <div class="action-bar d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
            <div class="d-flex flex-wrap gap-2">
              <button type="submit" name="save" class="btn btn-primary btn-sm">
                <i class="fas fa-save"></i><span class="btn-label ms-1">Save</span>
              </button>
              <button type="submit" name="save_and_new" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i><span class="btn-label ms-1">New</span>
              </button>
              <button type="submit" name="save_and_print" class="btn btn-secondary btn-sm">
                <i class="fas fa-print"></i><span class="btn-label ms-1">Print</span>
              </button>
            </div>

            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-secondary btn-sm" type="button" onclick="history.back()">
                <i class="fas fa-arrow-left"></i><span class="btn-label ms-1">Back</span>
              </button>
              <a href="{% if form.instance.pk %}{{ form.instance.get_absolute_url }}{% else %}{% url 'payments:cash_ledger' %}{% endif %}"
                 class="btn btn-danger btn-sm">
                <i class="fas fa-times"></i> Cancel
              </a>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- RIGHT: Recent Payments (stays side-by-side on md+) -->
  <div class="col-12 col-md-7">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center py-2">
        <h5 class="mb-0">Recent Payments</h5>

        <div class="d-flex align-items-center gap-2">
          <label for="recentSize" class="mb-0 small text-muted">Rows</label>
          <select id="recentSize" class="form-select form-select-sm" style="width:auto">
            {% for opt in recent_size_options %}
              <option value="{{ opt }}" {% if recent_size == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
          <span class="badge bg-secondary">{{ recent_payments|length }}</span>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 recent-payments-table">
            <thead class="bg-light">
              <tr>
                <th class="col-sn">#</th>
                <th class="col-tenant">Tenant</th>
                <th class="col-date">Date</th>
                <th class="col-amount">Amount</th>
                <th class="col-pu">Property-Unit</th>
                <th class="col-actions">Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for payment in recent_payments %}
                <tr>
                  <td class="col-sn">{{ forloop.counter }}</td>

                  <td class="col-tenant">
                    <span class="tenant-2clamp">
                      {{ payment.lease.tenant.get_full_name }}
                    </span>
                  </td>

                  <td class="col-date">{{ payment.payment_date|date:"M j, Y" }}</td>

                  <td class="col-amount">{{ payment.amount|intcomma }}</td>

                  <td class="col-pu">
                    <span class="pu-desktop d-none d-sm-inline">
                      {{ payment.lease.unit.property.property_name|truncatechars:10 }}-{{ payment.lease.unit.unit_number }}
                    </span>
                    <span class="pu-mobile d-inline d-sm-none">
                      <span class="prop">{{ payment.lease.unit.property.property_name }}</span>
                      <span class="unit">{{ payment.lease.unit.unit_number }}</span>
                    </span>
                  </td>

                  <td class="col-actions text-nowrap">
                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'payments:payment_detail' payment.id %}"
                         class="btn btn-dark" title="View">
                        <i class="fas fa-eye"></i>
                        <span class="ms-1 d-none d-sm-inline">View</span>
                      </a>

                      <button
                        class="btn btn-success payment-action"
                        data-action="whatsapp"
                        data-phone="{{ payment.lease.tenant.phone }}"
                        data-name="{{ payment.lease.tenant.first_name }}"
                        data-property="{{ payment.lease.unit.property.property_name }}"
                        data-unit="{{ payment.lease.unit.unit_number }}"
                        data-amount="{{ payment.amount }}"
                        data-date="{{ payment.payment_date|date:'M d, Y' }}"
                        data-balance="{{ payment.lease.get_balance }}"
                        data-start-date="{{ payment.lease.start_date|date:'M d, Y' }}"
                        data-end-date="{{ payment.lease.end_date|date:'M d, Y' }}"
                        data-security-amount="{{ payment.lease.security_deposit|default:0 }}"
                        data-security-paid="{{ payment.lease.security_deposit_paid|yesno:'true,false' }}"
                        title="WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                        <span class="ms-1 d-none d-sm-inline">WhatsApp</span>
                      </button>

                      <button class="btn btn-info payment-action" data-action="sms" title="SMS">
                        <i class="fas fa-sms"></i><span class="ms-1 d-none d-sm-inline">SMS</span>
                      </button>

                      <button class="btn btn-primary payment-action" data-action="email" title="Email">
                        <i class="fas fa-envelope"></i><span class="ms-1 d-none d-sm-inline">Email</span>
                      </button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="6" class="text-center text-muted">No recent payments</td></tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ===== Base compact bits ===== */
  .compact-form .form-group{margin-bottom:.5rem}
  .compact-form .form-control,.compact-form .form-select{
    padding:.25rem .5rem;font-size:.8125rem;height:calc(1.5em + .5rem + 2px)
  }
  .compact-form .card{margin-bottom:.75rem;border:1px solid rgba(0,0,0,.1)}
  .compact-form .card-header{padding:.25rem .75rem}
  .compact-form .card-body{padding:.5rem}
  .compact-form label{margin-bottom:.1rem;font-size:.8125rem}
  .table-sm td,.table-sm th{padding:.25rem;font-size:.7125rem}

  .compact-select { padding:.2rem .4rem; font-size:.85rem; line-height:1.2; }
  .one-line { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* balances as badges (NOT textbox look) */
  .balance-pill{
    display:inline-flex;
    align-items:center;
    min-height: 28px;
    padding: .15rem .5rem;
    border-radius: 9999px;
    background: rgba(0,0,0,.06);
    border: 1px solid rgba(0,0,0,.08);
    font-weight: 700;
    font-size: .85rem;
    line-height: 1.1;
  }

  /* If crispy adds form-control styles to allocation fields, keep them compact */
  #id_lease_amount, #id_security_amount, #id_amount{
    text-align: right;
  }

  /* ===== Select2 compact ===== */
  #id_tenant_search + .select2 .select2-selection--single,
  #id_lease + .select2 .select2-selection--single{
    min-height: 26px; height: 26px;
  }
  #id_tenant_search + .select2 .select2-selection__rendered,
  #id_lease + .select2 .select2-selection__rendered{
    font-size: .72rem;
    line-height: 24px;
    padding-right: 22px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #id_tenant_search + .select2 .select2-selection__arrow,
  #id_lease + .select2 .select2-selection__arrow{
    height: 26px;
  }
  .select2-dropdown.compact-dd{ font-size:.72rem !important; }
  .select2-dropdown.compact-dd .select2-search__field{
    height: 26px !important; padding: 2px 6px !important; font-size:.72rem !important;
  }
  .select2-dropdown.compact-dd .select2-results__options{ max-height: 320px !important; }
  .select2-dropdown.compact-dd .select2-results__option{
    padding: 2px 6px !important; line-height: 1.10 !important; min-height: 22px !important;
    white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;
  }

  /* Lease status badge in Select2 dropdown */
  .select2-results__option .lease-badge{
    display:inline-block; padding: 0 .35rem; margin-left:.4rem;
    border-radius: 9999px; font-size:.65rem; line-height:1.35; vertical-align:middle; color:#fff;
  }
  .select2-results__option .lease-badge.ended,
  .select2-results__option .lease-badge.terminated{ background:#dc3545; }
  #id_lease + .select2 .select2-selection__rendered .lease-badge{ margin-left:.35rem; }

  /* ===== Recent Payments widths (desktop/tablet) ===== */
  .recent-payments-table{
    table-layout:fixed;width:100%;
    --w-sn:      28px;
    --w-tenant:  20%;
    --w-date:    16%;
    --w-amount:  14%;
    --w-pu:      34%;
    --w-actions: 320px;
  }
  .recent-payments-table th.col-sn,      .recent-payments-table td.col-sn      { width:var(--w-sn) }
  .recent-payments-table th.col-tenant,  .recent-payments-table td.col-tenant  { width:var(--w-tenant) }
  .recent-payments-table th.col-date,    .recent-payments-table td.col-date    { width:var(--w-date) }
  .recent-payments-table th.col-amount,  .recent-payments-table td.col-amount  { width:var(--w-amount) }
  .recent-payments-table th.col-pu,      .recent-payments-table td.col-pu      { width:var(--w-pu) }
  .recent-payments-table th.col-actions, .recent-payments-table td.col-actions { width:var(--w-actions) }
  .recent-payments-table td, .recent-payments-table th{
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap
  }
  .recent-payments-table .col-actions .btn-group{ gap:.3rem; }
  .recent-payments-table .col-actions .btn-group .btn{
    padding:.18rem .32rem !important;
    font-size:.78rem !important;
    line-height:1.05 !important;
  }
  .recent-payments-table .col-actions .btn i{ font-size:.85em; }

  @media (min-width:576px){
    .pu-desktop{display:inline!important}
    .pu-mobile{display:none!important}
  }

  /* Phones: compact + keep your mobile behavior */
  @media (max-width: 575.98px){
    html,body{height:auto;overflow-y:auto}
    .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch}

    /* Action bar: icons-only */
    .action-bar .btn .btn-label{display:none!important}

    .recent-payments-table{
      --w-sn:      20px;
      --w-tenant:  23%;
      --w-date:    20%;
      --w-pu:      auto;
      --w-actions: 80px;
    }
    .recent-payments-table th.col-amount,.recent-payments-table td.col-amount{display:none!important}

    td.col-date .amount-sub{
      display:block;margin-top:.15rem;line-height:1.1;font-weight:600;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .tenant-2clamp{
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      overflow:hidden;text-overflow:ellipsis;white-space:normal;line-height:1.15;
    }

    .pu-desktop{display:none!important}
    .pu-mobile{display:inline!important}
    .pu-mobile .prop,.pu-mobile .unit{
      display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.15;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  const IS_EDIT = {{ form.instance.pk|yesno:"true,false" }};
</script>

<script>
(function($){
  $(function(){
    initSelect2();
    wireSelect2AutoFocus();
    updateAllLists();
    setupDelegatedWhatsApp();
    enhanceMobileRows();

    // Change recent rows (10/20/50)
    const sel = document.getElementById('recentSize');
    if (sel){
      sel.addEventListener('change', function(){
        const url = new URL(window.location.href);
        url.searchParams.set('recent_size', this.value);
        window.location.assign(url.toString());
      });
    }

    // Require a lease before submit
    $('#paymentForm').on('submit', function(e){
      if (!$('#id_lease').val()) {
        e.preventDefault();
        alert('Please select a lease before submitting.');
      }
    });

    // Reset Filters
    $('#resetFilters').on('click', function(){
      $('#id_tenant_search, #id_property, #id_unit, #id_lease').val(null).trigger('change');
      $('#id_include_inactive').prop('checked', false);
      $('#id_amount').val('');
      setBalancesUI(null);
      updateAllLists();
    });

    // Amount normalization ONLY on submit (no typing restriction)
    document.getElementById('paymentForm')?.addEventListener('submit', function(e){
      const el = document.getElementById('id_amount');
      if (!el) return;
      let raw = (el.value || '').trim().replace(/,/g,'');
      const val = Number(raw);
      if (!raw || isNaN(val)) {
        e.preventDefault();
        alert('Please enter a valid numeric amount.');
        el.focus();
        return;
      }
      el.value = val.toFixed(2);
    }, { passive:false });

    // Allocation sync (single source of truth)
    initAllocationSync();
  });

  function initSelect2(){
    function escapeMarkup(m){ return m; }

    function renderTenantNode(item){
      if (!item.id) return item.text;
      const txt = (item.text || '').trim();
      const short = txt.length > 20 ? (txt.slice(0,20) + '…') : txt;
      return $('<span class="one-line"></span>').text(short).attr('title', txt);
    }

    function renderLeaseNode(item){
      if (!item.id) return item.text;

      let status = '';
      if (item.element) status = ($(item.element).data('status') || '').toString().toLowerCase();
      if (!status && item.id) {
        const opt = $('#id_lease').find('option[value="'+ item.id +'"]');
        if (opt.length) status = (opt.data('status') || '').toString().toLowerCase();
      }
      if (!status && item.status) status = (item.status || '').toString().toLowerCase();

      const $row = $('<span class="lease-row"></span>').text(item.text || '');
      if (status && status !== 'active'){
        const label = (status === 'ended' ? 'Ended' : status === 'terminated' ? 'Terminated' : 'Inactive');
        $row.append($('<span class="lease-badge"/>').addClass(status).text(label));
      }
      return $row;
    }

    $('#id_tenant_search').select2({
      width:'100%',
      allowClear:true,
      placeholder:'',
      dropdownAutoWidth:true,
      dropdownCssClass:'compact-dd',
      minimumResultsForSearch:0,
      escapeMarkup: escapeMarkup,
      templateResult: renderTenantNode,
      templateSelection: renderTenantNode
    });

    $('#id_lease').select2({
      width:'100%',
      allowClear:true,
      placeholder:'',
      dropdownAutoWidth:true,
      dropdownCssClass:'compact-dd',
      minimumResultsForSearch:0,
      escapeMarkup: escapeMarkup,
      templateResult: renderLeaseNode,
      templateSelection: renderLeaseNode
    });

    $('#id_property, #id_unit').select2({
      width:'100%',
      allowClear:true,
      placeholder:'',
      minimumResultsForSearch:0
    });
  }

  function wireSelect2AutoFocus(){
    $(document).on('select2:open', function(){
      const s = document.querySelector('.select2-container--open .select2-search__field');
      if (s) { s.focus(); if (s.select) s.select(); }
    });
  }

  function updateAllLists(){
    populateTenantFilter();
    populateUnitFilter();
    updateLeaseList();
  }

  function getTenantId(obj){
    const cand = [
      obj.tenant_id, obj.tenantId, obj.tenant_pk,
      (obj.tenant && obj.tenant.id), (obj.tenant && obj.tenant.pk),
      (typeof obj.tenant === 'number' ? obj.tenant : null)
    ].find(v => v !== undefined && v !== null);
    if (cand == null) return null;
    const s = String(cand).trim();
    return (/^[0-9a-fA-F-]+$/.test(s) ? s : null);
  }
  function getTenantLabel(obj){
    const cand = [
      obj.tenant_name, obj.tenantName, obj.tenant_full_name, obj.tenant_fullname,
      obj.tenant_display, obj.tenant_display_name,
      obj.tenant, obj.text
    ].find(v => typeof v === 'string' && v.trim().length);
    return (cand ? String(cand).trim() : (getTenantId(obj) || 'Tenant'));
  }

  function populateTenantFilter(){
    const $sel = $('#id_tenant_search');
    $.get("{% url 'payments:get_filtered_leases' %}", {
      property_id: $('#id_property').val() || '',
      include_inactive: $('#id_include_inactive').is(':checked')
    }, null, 'json')
    .done(function(data){
      const leases = (data && Array.isArray(data.leases)) ? data.leases : [];
      const frag = document.createDocumentFragment();
      const unique = new Set();
      frag.appendChild(new Option('All Tenants', '', false, false));

      leases.forEach(l => {
        const tid = getTenantId(l);
        if (!tid || unique.has(tid)) return;
        unique.add(tid);
        frag.appendChild(new Option(getTenantLabel(l), tid, false, false));
      });

      $sel.empty()[0].appendChild(frag);
      $sel.trigger('change.select2');
      updateLeaseList();
    })
    .fail(function(){ $sel.trigger('change.select2'); });
  }

  function populateUnitFilter(){
    $.get("{% url 'payments:get_filtered_leases' %}", {
      property_id: $('#id_property').val() || '',
      include_inactive: $('#id_include_inactive').is(':checked')
    }, function(data){
      const $sel = $('#id_unit').empty().append('<option value=""></option>');
      const seen = new Set();
      (data.leases || []).forEach(l => {
        const unitId = l.unit_id || l.unitId || l.unit_id_id;
        if (!unitId || seen.has(unitId)) return;
        seen.add(unitId);
        const label = `${(l.unit||'').trim()} — ${(l.tenant||l.text||'').slice(0,20)}${(l.tenant||l.text||'').length>20?'…':''}`;
        $('<option>').val(unitId).text(label).appendTo($sel);
      });
      $sel.trigger('change.select2');
      updateLeaseList();
    });
  }

  function getLeaseIdFromURL(){
    const m = new URLSearchParams(window.location.search).get('lease');
    return m && String(m).trim() ? m : null;
  }
  let didURLPreselect = false;

  function setBalancesUI(leaseData){
    const lb = document.getElementById("lease-balance-display");
    const sb = document.getElementById("sec-balance-display");
    if (!lb || !sb) return;

    if (!leaseData){
      lb.textContent = "—";
      sb.textContent = "—";
      return;
    }
    lb.textContent = "Rs. " + (leaseData.balance || "0.00");
    sb.textContent = "Rs. " + (leaseData.sec_balance || "0.00");
  }

  function updateLeaseList(){
    const $lease = $('#id_lease');
    const urlLease = getLeaseIdFromURL();
    const current = $lease.val() || (!didURLPreselect && urlLease);

    $.get("{% url 'payments:get_filtered_leases' %}", {
      tenant_id: $('#id_tenant_search').val() || '',
      property_id: $('#id_property').val() || '',
      unit_id: $('#id_unit').val() || '',
      include_inactive: $('#id_include_inactive').is(':checked'),
      lease: urlLease || ''
    }, function(data){
      const leases = data.leases || [];
      $lease.empty().append('<option value=""></option>');

      leases.forEach(l => {
        const $opt = $('<option>', { value: l.id, text: l.text });
        $opt.attr({
          'data-tenant': (l.tenant||''),
          'data-property': (l.property||''),
          'data-unit': (l.unit||''),
          'data-balance': (l.balance||''),
          'data-sec_balance': (l.sec_balance||''),
          'data-phone': (l.phone||''),
          'data-security_amount': (l.security_amount||''),
          'data-security_paid': (l.security_paid ? 'true' : 'false'),
          'data-start_date': (l.start_date||''),
          'data-end_date': (l.end_date||''),
          'data-status': (l.status||'')
        });
        $opt.appendTo($lease);
      });

      let target = null;
      if (current && leases.some(l => String(l.id) === String(current))) {
        target = current;
      } else if (!didURLPreselect && urlLease && leases.some(l => String(l.id) === String(urlLease))) {
        target = urlLease;
        didURLPreselect = true;
      } else if (leases.length === 1) {
        target = leases[0].id;
      }

      if (target){
        $lease.val(String(target)).trigger('change.select2').trigger('change');
      } else {
        setBalancesUI(null);
      }
      $lease.trigger('change.select2');
    });
  }

  // React to filter changes
  $('#id_tenant_search').on('change', updateLeaseList);
  $('#id_unit').on('change', updateLeaseList);

  $('#id_property').on('change', function(){
    const propId = $(this).val();
    const $unit = $('#id_unit').empty().append('<option value=""></option>');
    if (propId){
      $.get("{% url 'payments:get_units_by_property' %}", { property_id: propId }, function(data){
        (data.units || []).forEach(u => $('<option>').val(u.id).text(String(u.unit_number || u.text || '')).appendTo($unit));
        $unit.trigger('change.select2');
        updateLeaseList();
      });
    } else {
      updateLeaseList();
    }
    $('#id_tenant_search').val(null).trigger('change');
  });

  $('#id_include_inactive').on('change', updateAllLists);

  // Lease change → update balances
  $('#id_lease').on('change', function(){
    const $opt = $(this).find(':selected');
    if (!$opt.val()){
      setBalancesUI(null);
      return;
    }
    const leaseData = {
      balance: $opt.data('balance'),
      sec_balance: $opt.data('sec_balance'),
    };
    setBalancesUI(leaseData);
  });

  /* =========================
     WhatsApp (delegated)
     ========================= */
  function setupDelegatedWhatsApp(){
    $(document).on('click', '.payment-action[data-action="whatsapp"]', function(e){
      e.preventDefault();
      const $b = $(this);
      const opts = {
        phone:          $b.data('phone') || '',
        firstName:      $b.data('name') || '',
        propertyName:   $b.data('property') || '',
        unitNumber:     $b.data('unit') || '',
        amount:         $b.data('amount'),
        paymentDate:    $b.data('date') || '',
        balance:        $b.data('balance'),
        startDate:      $b.data('start-date') || '',
        endDate:        $b.data('end-date') || '',
        securityAmount: $b.data('security-amount'),
        securityPaid:   String($b.data('security-paid')).toLowerCase() === 'true'
      };
      sendWhatsAppSingle(opts);
    });
  }

  function sendWhatsAppSingle(opts){
    const { phone, firstName, propertyName, unitNumber, amount, paymentDate, balance, startDate, endDate, securityAmount, securityPaid } = opts;
    if (!phone) { alert('No phone number available.'); return; }

    let cleaned = String(phone).replace(/[^\d+]/g,'');
    if (/^0\d+$/.test(cleaned)) cleaned = '+92' + cleaned.slice(1);

    const asNum = v => parseFloat(String(v).replace(/,/g,'')) || 0;
    const fmt   = v => asNum(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

    const message =
`Dear ${firstName},
Payment received for
Unit: ${propertyName}-${unitNumber}
Period: ${startDate} – ${endDate}
Security Deposit: Rs. ${fmt(securityAmount)} (${securityPaid ? 'Paid' : 'Pending'})
Date: ${paymentDate}
Amount: Rs. ${fmt(amount)}
Balance: Rs. ${fmt(balance)}

Thank you!`;

    window.open(
      'https://api.whatsapp.com/send?phone=' + encodeURIComponent(cleaned) +
      '&text=' + encodeURIComponent(message),
      '_blank'
    );
  }

  /* =========================
     Mobile enhancement: put Amount under Date
     ========================= */
  function enhanceMobileRows(){
    const MQ = window.matchMedia('(max-width: 575.98px)');
    if (!MQ.matches) return;
    document.querySelectorAll('.recent-payments-table tbody tr').forEach(tr => {
      if (tr.dataset.enhancedAmount === '1') return;
      let tdDate   = tr.querySelector('td.col-date');
      let tdAmount = tr.querySelector('td.col-amount');
      if (tdDate && tdAmount){
        const txt = (tdAmount.textContent || '').trim();
        if (txt && !tdDate.querySelector('.amount-sub')){
          const el = document.createElement('div');
          el.className = 'amount-sub';
          el.textContent = txt;
          tdDate.appendChild(el);
        }
      }
      tr.dataset.enhancedAmount = '1';
    });
  }

  /* =========================
     Allocation sync (editable)
     ========================= */
  function initAllocationSync(){
    function n(v){ return parseFloat(String(v||"").replace(/,/g,"")) || 0; }
    function f2(v){ return (Math.round(v*100)/100).toFixed(2); }

    const $form  = $('#paymentForm');
    const $mode  = $('#id_allocation_mode');
    const $total = $('#id_amount');
    const $lease = $('#id_lease_amount');
    const $sec   = $('#id_security_amount');

    if (!$form.length || !$mode.length || !$total.length || !$lease.length || !$sec.length) return;

    let lock = false;

    function applyMode(){
      const mode = ($mode.val() || 'LEASE').toUpperCase();
      const total = n($total.val());

      if (mode === 'LEASE'){
        $lease.prop('readonly', true).val(f2(total));
        $sec.prop('readonly', true).val(f2(0));
        return;
      }
      if (mode === 'SECURITY'){
        $lease.prop('readonly', true).val(f2(0));
        $sec.prop('readonly', true).val(f2(total));
        return;
      }

      // SPLIT
      $lease.prop('readonly', false);
      $sec.prop('readonly', false);

      // If both empty, default split = all lease
      if (!$lease.val() && !$sec.val()){
        $lease.val(f2(total));
        $sec.val(f2(0));
      } else {
        reconcile('lease');
      }
    }

    function reconcile(changed){
      if (lock) return;
      lock = true;

      const mode = ($mode.val() || 'LEASE').toUpperCase();
      const total = n($total.val());

      if (mode !== 'SPLIT'){
        applyMode();
        lock = false;
        return;
      }

      let leaseAmt = n($lease.val());
      let secAmt   = n($sec.val());

      if (changed === 'lease'){
        secAmt = Math.max(0, total - leaseAmt);
        $sec.val(f2(secAmt));
      } else if (changed === 'sec'){
        leaseAmt = Math.max(0, total - secAmt);
        $lease.val(f2(leaseAmt));
      } else {
        // total changed → keep lease as-is then adjust security
        secAmt = Math.max(0, total - leaseAmt);
        $sec.val(f2(secAmt));
      }

      lock = false;
    }

    // If user clicks into allocation fields, switch to SPLIT so typing works.
    $lease.on('focus', function(){
      if (($mode.val() || '').toUpperCase() !== 'SPLIT'){
        $mode.val('SPLIT').trigger('change');
      }
    });
    $sec.on('focus', function(){
      if (($mode.val() || '').toUpperCase() !== 'SPLIT'){
        $mode.val('SPLIT').trigger('change');
      }
    });

    $mode.on('change', function(){ applyMode(); });
    $total.on('input', function(){ reconcile('total'); });
    $lease.on('input', function(){ reconcile('lease'); });
    $sec.on('input', function(){ reconcile('sec'); });

    // Before submit: ensure sum matches
    $form.on('submit', function(e){
      const total = n($total.val());
      const sum = n($lease.val()) + n($sec.val());
      if (Math.abs(total - sum) > 0.009){
        e.preventDefault();
        alert(`Allocation mismatch: lease+security = ${sum.toFixed(2)} but payment = ${total.toFixed(2)}`);
      }
    });

    // initial
    applyMode();
  }

})(jQuery);
</script>
{% endblock %}
