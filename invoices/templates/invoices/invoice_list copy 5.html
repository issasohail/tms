{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}

{% block title %}Invoices{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 page-header">
  <h2 class="h4 mb-0">Invoices</h2>

  <div class="top-actions d-flex align-items-center flex-wrap gap-2">
    <a href="{% url 'invoices:invoice_create' %}" class="btn btn-primary">
      <i class="fas fa-plus"></i><span class="btn-label"> New Invoice</span>
    </a>

    {% include "includes/export_buttons.html" %}

    <a href="{% url 'invoices:generate_monthly' %}" class="btn btn-success">
      <i class="fas fa-file-invoice-dollar"></i><span class="btn-label"> Generate Billing</span>
    </a>

    <a href="{% url 'invoices:recurring_wizard' %}" class="btn btn-success">
      <i class="fas fa-redo-alt"></i><span class="btn-label"> Recurring Invoice</span>
    </a>

    <a href="{% url 'invoices:waterbill_list' %}" class="btn btn-success">
      <i class="fas fa-tint"></i><span class="btn-label"> Water Bill</span>
    </a>

    <a href="{% url 'invoices:category_list' %}" class="btn btn-success">
      <i class="fas fa-list"></i><span class="btn-label"> View Category</span>
    </a>

    {# Option A: Month rollback PREVIEW — at top with other buttons #}
    <form method="get" action="{% url 'invoices:invoices_bulk_delete_preview' %}" class="d-inline-flex align-items-center gap-1">
      <div class="input-group" style="max-width: 300px;">
        <span class="input-group-text">Month</span>
        <input type="month" name="month" required class="form-control">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-trash"></i> Preview Rollback
        </button>
      </div>
    </form>
  </div>
</div>


<form id="invoice-filter-form" method="get" class="card card-body mb-3 filters-card">
  <div class="filters-grid">
    <select name="period" id="id_period" class="form-select form-select-sm" title="Period">
      <option value="">All</option>
      <option value="today"      {% if request.GET.period == 'today' %}selected{% endif %}>Today</option>
      <option value="yesterday"  {% if request.GET.period == 'yesterday' %}selected{% endif %}>Yesterday</option>
      <option value="this_week"  {% if request.GET.period == 'this_week' %}selected{% endif %}>This Week</option>
      <option value="last_week"  {% if request.GET.period == 'last_week' %}selected{% endif %}>Last Week</option>
      <option value="this_month" {% if request.GET.period == 'this_month' %}selected{% endif %}>This Month</option>
      <option value="last_month" {% if request.GET.period == 'last_month' %}selected{% endif %}>Last Month</option>
      <option value="next_month" {% if request.GET.period == 'next_month' %}selected{% endif %}>Next Month</option>
      <option value="this_year"  {% if request.GET.period == 'this_year' %}selected{% endif %}>This Year</option>
    </select>

    <input type="date" class="form-control form-control-sm" name="start_date" id="id_start_date"
           value="{{ request.GET.start_date }}" title="From">
    <input type="date" class="form-control form-control-sm" name="end_date" id="id_end_date"
           value="{{ request.GET.end_date }}" title="To">

    <div class="filter-item property-item">
      <select name="property" id="id_property" class="form-select form-select-sm" title="Property">
        <option value="">Property</option>
        {% for p in property_options %}
          <option value="{{ p.id }}" {% if request.GET.property == p.id|stringformat:'s' %}selected{% endif %}>
            {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <select name="unit" id="id_unit" class="form-select form-select-sm" title="Unit" disabled></select>

    <select name="lease" id="id_lease" class="form-select form-select-sm" title="Lease">
      <option value="">Lease</option>
      {% for opt in lease_options %}
        <option value="{{ opt.id }}" {% if request.GET.lease == opt.id|stringformat:'s' %}selected{% endif %}>
          {{ opt.label }}
        </option>
      {% endfor %}
    </select>

    <button class="btn btn-secondary btn-sm action-btn" type="submit" title="Apply">
      <i class="fas fa-filter"></i><span class="btn-text ms-1">Apply</span>
    </button>
    <a class="btn btn-outline-secondary btn-sm action-btn" href="?" title="Clear">
      <i class="fas fa-undo"></i><span class="btn-text ms-1">Clear</span>
    </a>

    <label class="inactive-toggle mb-0" title="Show inactive">
      <input class="form-check-input" type="checkbox" id="id_show_inactive" name="show_inactive" value="1"
             {% if show_inactive %}checked{% endif %}>
      <span class="label-top">Show</span>
      <span class="label-bottom">inactive</span>
    </label>
  </div>
</form>

{# Option B: Delete selected — PREVIEW first (POST -> preview page). DO NOT nest forms. #}
<form method="post" action="{% url 'invoices:invoices_bulk_delete_preview' %}">
  {% csrf_token %}
  <div class="table-responsive table-mobile-sm">
    {% render_table table %}
  </div>

  <button type="submit" class="btn btn-outline-danger mt-2">
    <i class="bi bi-search"></i> Preview Delete (Selected)
  </button>
</form>
{% endblock %}




{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
/* ---------- Top actions ---------- */
.page-actions { display: inline-flex; gap: .5rem; flex-wrap: wrap; }
.btn-xs { padding: .3rem .45rem; font-size: .8rem; line-height: 1.1; }

.actions-wrap .btn .btn-text,
    .actions-wrap .btn .btn-label { display: none !important; }
    
/* ---------- Filters (desktop) ---------- */
.filters-card { padding: .5rem .75rem; }
.filters-grid {
  display: grid;
  grid-template-columns:
    7rem   /* Period */
    8rem   /* From */
    8rem   /* To */
    8rem  /* Property */
    10rem  /* Unit */
    12rem   /*minmax(18rem,1fr)  Lease */
    6rem   /* Apply */
    6rem   /* Clear */
    6.5rem /* Show inactive */;
  gap: .5rem;
  align-items: center;
}
.inactive-toggle {
  display: grid; grid-template-columns: auto 1fr; grid-template-rows: 1fr 1fr;
  column-gap: .4rem; align-items: center; padding: .2rem .4rem;
  border: 1px solid var(--bs-border-color, #e0e0e0); border-radius: .375rem; background: var(--bs-body-bg,#fff);
}
.inactive-toggle input { grid-row: 1 / span 2; align-self: center; margin: 0; }
.inactive-toggle .label-top, .inactive-toggle .label-bottom { line-height: 1.05; font-size: .78rem; display: block; }

/* ---------- Table widths & dates ---------- */
/* Order: 1 S.N# | 2 Invoice# | 3 Property–Unit | 4 Tenant | 5 Description | 6 Issue | 7 Due | 8 Amount | 9 Actions */
table.table th:nth-child(1), table.table td:nth-child(1) { width: 4rem; text-align: center; }
table.table th:nth-child(2), table.table td:nth-child(2) { width: 4rem; }      /* Invoice# */
table.table th:nth-child(3), table.table td:nth-child(3) { width: 16rem; }     /* Property–Unit */
table.table th:nth-child(4), table.table td:nth-child(4) { width: 10rem; white-space: nowrap; } /* Tenant */
table.table th:nth-child(5), table.table td:nth-child(5) { max-width: 30ch; }  /* Description */
table.table th:nth-child(6), table.table td:nth-child(6) { width: 9rem; white-space: nowrap;  overflow:hidden;  } /* Issue */
table.table th:nth-child(7), table.table td:nth-child(7) {  width: 9rem;white-space: nowrap;  overflow:hidden;  } /* Due */
table.table th:nth-child(8), table.table td:nth-child(8) { width: 9rem; text-align: right; }   /* Amount */
table.table th:nth-child(9), table.table td:nth-child(9) { width: 7rem; }       /* Actions */

/* ---------- Small screens (≤400px) ---------- */
/* ===== SMALL SCREENS (≤ 400px) — compact, readable, no scroll ===== */
@media (max-width: 400px) {
  /* Global tiny font & tight spacing */
  body, .btn, .form-select, .form-control, table.table { font-size: .70rem; }
  .mb-3 { margin-bottom: .2rem !important; }

  /* Hide page H2 to save space (you asked this earlier) */
  .page-header .h4 { display: none; }

  

  /* ===== TOP ACTIONS: 2 rows × 3 items (with horizontal scroll if >6 items) ===== */
.top-actions {
  display: grid;
  grid-template-rows: repeat(2, minmax(2.2rem, auto));   /* exactly two rows */
  grid-auto-flow: column;                                 /* fill rows first, then new column */
  grid-auto-columns: minmax(7.5rem, 1fr);                 /* each “slot” width */
  gap: .2rem;
  width: 100%;
  overflow-x: auto;                                       /* if >6 items, scroll sideways */
  overscroll-behavior-x: contain;
  scroll-snap-type: x mandatory;                          /* nice snapping while scrolling */
  padding-bottom: .15rem;                                 /* room for scrollbar */
}

.top-actions > * {
  scroll-snap-align: start;
  min-width: 0;                                           /* prevent overflow inside slots */
}

/* Buttons compact + readable with icon + text */
.top-actions .btn {
  font-size: .70rem !important;
  width: 100%;
  padding: .22rem .28rem;
  line-height: 1.1;
  border-radius: .3rem;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.top-actions .btn i { font-size: .85rem; margin-right: .25rem; }
.top-actions .btn .btn-label,
.top-actions .btn span,
.top-actions .btn .text,
.top-actions .btn .label { display: inline !important; }

/* ===== MONTH + PREVIEW ROLLBACK: single row on small screens ===== */
.top-actions form[action*="invoices_bulk_delete_preview"] .input-group {
  display: grid !important;
  grid-template-columns: auto 1fr auto;   /* [Month] [ <input type=month> ] [ Preview ] */
  align-items: center;
  gap: .25rem;
  width: 100% !important;
  max-width: none !important;
}
.top-actions form[action*="invoices_bulk_delete_preview"] .input-group-text {
  padding: .20rem .35rem;
  font-size: .70rem;
}
.top-actions form[action*="invoices_bulk_delete_preview"] input[type="month"] {
  min-width: 0;            /* allow to shrink in tight spaces */
  height: 1.65rem;
  padding: .25rem .4rem;
  font-size: .70rem;
}
.top-actions form[action*="invoices_bulk_delete_preview"] button {
  padding: .22rem .35rem;
  font-size: .70rem;
  white-space: nowrap;
}

/* If your export buttons render as a small group, let them fit in one slot */
.top-actions .btn-group,
.top-actions .dropdown,
.top-actions .export-buttons { width: 100%; }

/* Optional: hide H2 to save vertical space (already in your CSS, kept here) */
.page-header .h4 { display: none; }


  /* ===== Filters: keep your previous (good) design =====
     - 3 controls per row
     - modest gaps
     - property ~40% narrower
     - no horizontal scrolling
  */
  .filters-card { padding: .35rem .45rem; border: 0; box-shadow: none; }
  .filters-grid {
    display: grid  !important;
    grid-template-columns: 1fr 1fr 1fr  !important;  /* 3 per row */
    gap: .35rem  !important;                         /* restore earlier spacing you liked */
  }
  /* Inputs/buttons compact so they don’t wrap */
  .filters-grid .form-select,
  .filters-grid .form-control,
  .filters-grid .action-btn,
  .inactive-toggle {
    width: 100%;
    height: 1.65rem;
    padding: .25rem .40rem;
    font-size: .70rem;
    line-height: 1.1;
  }
  /* Property ~40% narrower inside its slot (same as earlier) */
  .filters-grid .property-item { display: flex; }
  
    /* Property narrower but still one slot */
  .filters-grid .property-item { display: flex; min-width: 0; }

  /* Make sure Apply / Clear sit side-by-side (each 1 slot) */
  .filters-grid .action-btn { white-space: nowrap; }

  /* (Optional) keep “Show inactive” as a single slot, not spanning rows */
  .inactive-toggle { grid-column: auto / span 1 !important; }

    /* Each direct child = one slot; allow shrinking inside cells */
  .filters-grid > * {
    grid-column: auto / span 1 !important;
    min-width: 0 !important;
  }

  /* Filter action buttons — keep compact; text optional here */
  .filters-grid .action-btn { padding: .28rem .35rem; font-size: .70rem; }

  /* Show inactive (two-line label) remains compact */
  .inactive-toggle {
    display: grid;
    grid-template-columns: auto 1fr;
    grid-template-rows: 1fr 1fr;
    column-gap: .3rem;
    align-items: center;
    padding: .15rem .25rem;
    border: 1px solid #ddd;
    border-radius: .3rem;
  }
  .inactive-toggle input { grid-row: 1 / span 2; align-self: center; margin: 0; }
  .inactive-toggle .label-top,
  .inactive-toggle .label-bottom { font-size: .68rem; line-height: 1.05; }

  /* ===== Table compactness on mobile ===== */
  /* Hide these columns to prioritize data space (as you asked before) */
  table.table th:nth-child(3), table.table td:nth-child(3) { display: none; } /* Invoice# */
  table.table th:nth-child(5), table.table td:nth-child(5) { display: none; } /* Description */
  table.table th:nth-child(7), table.table td:nth-child(7) { display: none; } /* Due Date */

    .table-mobile-sm table.table th:nth-child(2),
  .table-mobile-sm table.table td:nth-child(2) {
    width: .4rem;          /* tweak width here */
    text-align: center;
    padding-left: .02rem;
    padding-right: .02rem;
  }

  /* Shrink the actual checkbox */
  .table-mobile-sm table.table th:nth-child(2) .form-check-input,
  .table-mobile-sm table.table td:nth-child(2) .form-check-input,
  .table-mobile-sm table.table th:nth-child(2) input[type="checkbox"],
  .table-mobile-sm table.table td:nth-child(2) input[type="checkbox"] {
    transform: scale(.8);            /* 80% size */
    -webkit-transform: scale(.8);
    transform-origin: center;
    margin: 0;                       /* remove default spacing */
  }

  /* Tenant clamp ~10ch; prevent wrapping */
  td.tenant-cell { max-width: 10ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* Dates (Issue/Due) stay one line, visually ≤ 11 chars */
  table.table td:nth-child(6),
  table.table td:nth-child(7) {
    white-space: nowrap;
    max-width: 11ch;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .table-mobile-sm table.table { font-size: .45rem !important; }

  .table-mobile-sm table.table th,
  .table-mobile-sm table.table td {
    padding: .2rem .3rem;
    line-height: 1.;
  }

  .table-mobile-sm .pagination,
  .table-mobile-sm .page-link {
    font-size: .45rem;
    padding: .25rem .4rem;
  }
  
  /* Smaller font for the table only (doesn’t affect navbar or filters) */
  .table-responsive .table { font-size: .70rem !important; }

  /* Tighten cell padding/row height */
  .table-responsive .table th,
  .table-responsive .table td {
    padding: .22rem .30rem;   /* ← tweak these to increase/decrease spacing */
    line-height: 1.1;
  }

  /* ---- ACTION BUTTONS inside the table: mobile tweaks ---- */
/* Scope to this page's table container if you used it */
/* Make the actions column as narrow as possible */
.table-mobile-sm td.actions-cell {
  width: 1%;                /* shrink-to-fit content */
  white-space: nowrap;
}
.table-mobile-sm td.actions-cell .actions-wrap { gap: .05rem;!important; }   /* space between buttons */

/* Button hit-box size (tweak here to reduce/increase overall space) */
.table-mobile-sm td.actions-cell .btn {
  padding: .10rem .12rem;   /* ← smaller than .16/.20; change to taste */
  line-height: 1;           /* no extra vertical room inside button */
  border-width: 1px;        /* keep borders thin */
}

/* Icon size (you set .50rem; change here later if needed) */
.table-mobile-sm td.actions-cell .btn i {
  font-size: .50rem;        /* ← tweak icon size here */
  margin-right: 0;          /* no space since label is hidden */
}

/* Hide the text labels to save space on small screens */
.table-mobile-sm td.actions-cell .btn .btn-label,
.table-mobile-sm td.actions-cell .btn i + span {
  display: none !important;
}
/* Small screens: 3 buttons per row; Month+Preview = full-width row underneath */
@media (max-width: 360px) {
  /* Ensure we're in flex mode and wrapping */
  .top-actions {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: .25rem !important;
    width: 100%;
  }

    /* Hide col #1 (Serial #) in header and body */
  .table-responsive table.table th:nth-child(3),
  .table-responsive table.table td:nth-child(3) {
    display: none !important;
  }
}

  /* Every normal action item takes exactly 1/3 width */
  .top-actions > a.btn,
  .top-actions > .btn,
  .top-actions > .dropdown,
  .top-actions > .btn-group,
  .top-actions > .export-buttons {
    flex: 0 0 calc(33.333% - .25rem) !important;
    max-width: calc(33.333% - .25rem) !important;
  }

  /* Make the Month + Preview Rollback form drop to its own row and span 100% */
  .top-actions form[action*="invoices_bulk_delete_preview"] {
    flex: 0 0 100% !important;
    max-width: 100% !important;
    order: 99; /* ensure it appears after the buttons */
  }

  /* Keep its internals on one line: [Month] [input] [Preview] */
  .top-actions form[action*="invoices_bulk_delete_preview"] .input-group {
    display: grid !important;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: .25rem;
    width: 100%;
    max-width: none;
  }

  .top-actions .input-group-text { padding: .20rem .35rem; font-size: .70rem; }
  .top-actions input[type="month"] { min-width: 0; height: 1.65rem; padding: .25rem .4rem; font-size: .70rem; }
  .top-actions button[type="submit"] { padding: .24rem .35rem; font-size: .70rem; white-space: nowrap; }
}




</style>

{% endblock %}

{% block extra_js %}
<script>
/* Period -> Dates + auto-submit */
(function(){
  const periodSel = document.getElementById('id_period');
  const start = document.getElementById('id_start_date');
  const end = document.getElementById('id_end_date');
  const form = document.getElementById('invoice-filter-form');

  function fmt(d){ return d.toISOString().slice(0,10); }
  function sow(d){ const c=new Date(d); const day=(c.getDay()+6)%7; c.setDate(c.getDate()-day); return c; }
  function eow(d){ const s=sow(d); const e=new Date(s); e.setDate(s.getDate()+6); return e; }
  function som(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function eom(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
  function soy(d){ return new Date(d.getFullYear(),0,1); }
  function eoy(d){ return new Date(d.getFullYear(),11,31); }

  periodSel.addEventListener('change', () => {
    const now = new Date();
    let s='', e='';
    switch(periodSel.value){
      case 'today': s=e=fmt(now); break;
      case 'yesterday': { const y=new Date(); y.setDate(now.getDate()-1); s=e=fmt(y); break; }
      case 'this_week': s=fmt(sow(now)); e=fmt(eow(now)); break;
      case 'last_week': { const n=new Date(); n.setDate(n.getDate()-7); s=fmt(sow(n)); e=fmt(eow(n)); break; }
      case 'this_month': s=fmt(som(now)); e=fmt(eom(now)); break;
      case 'last_month': { const d=new Date(now.getFullYear(), now.getMonth()-1, 1); s=fmt(som(d)); e=fmt(eom(d)); break; }
      case 'next_month': { const d=new Date(now.getFullYear(), now.getMonth()+1, 1); s=fmt(som(d)); e=fmt(eom(d)); break; }
      case 'this_year': s=fmt(soy(now)); e=fmt(eoy(now)); break;
      default: s=''; e='';
    }
    start.value = s; end.value = e;
    form.submit();
  });
})();

/* Property -> Units; auto-submit on change */
(function(){
  const propertySel = document.getElementById('id_property');
  const unitSel = document.getElementById('id_unit');
  const form = document.getElementById('invoice-filter-form');
  const unitsByProp = {{ units_by_property_json|safe }};

  function populateUnits(){
    const pid = propertySel.value;
    unitSel.innerHTML = '';
    if(!pid){ unitSel.disabled = true; return; }

    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'All units';
    unitSel.appendChild(allOpt);

    const opts = unitsByProp[pid] || [];
    opts.forEach(o => {
      const el = document.createElement('option');
      el.value = o.id;
      el.textContent = o.label; // Unit — Tenant — End — Status
      unitSel.appendChild(el);
    });
    unitSel.disabled = false;
  }

  populateUnits();
  propertySel.addEventListener('change', () => { populateUnits(); form.submit(); });
  unitSel.addEventListener('change', () => form.submit());
})();

/* Lease select auto-submit */
document.getElementById('id_lease')?.addEventListener('change', () => {
  document.getElementById('invoice-filter-form').submit();
});

/* Show inactive auto-submit */
document.getElementById('id_show_inactive')?.addEventListener('change', () => {
  document.getElementById('invoice-filter-form').submit();
});
</script>
<script>
  async function fetchWhatsAppPayload(url) {
    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
    let data;
    try { data = await res.json(); } catch (_) { data = {}; }
    if (!res.ok || data.error) {
      alert(data.error || 'Could not build WhatsApp message.');
      throw new Error(data.error || 'WhatsApp payload error');
    }
    return data; // { phone, message, ... }
  }

  function openWhatsApp(phone, message) {
    const p = String(phone || '').replace(/\D/g, '');
    if (!p) { alert('No phone number available for this tenant'); return; }
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const href = isMobile
      ? `https://wa.me/${p}?text=${encodeURIComponent(message || '')}`
      : `https://web.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(message || '')}`;
    window.open(href, '_blank');
  }
</script>
<script>
  // keep your existing fetchWhatsAppPayload...

  window.openWhatsAppPreferApp = function(win, phone, message) {
    const p = String(phone || '').replace(/\D/g, '');
    if (!p) throw new Error('No phone number available for this tenant');

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const text = encodeURIComponent(message || '');

    // URLs
    const appUrl = `whatsapp://send?phone=${p}&text=${text}`;                  // Desktop/Mobile app
    const webUrl = `https://web.whatsapp.com/send?phone=${p}&text=${text}`;    // Desktop fallback
    const mobileUrl = `https://wa.me/${p}?text=${text}`;                       // Mobile browsers

    // On mobile: go straight to wa.me (browser hands off to app)
    if (isMobile) {
      win.location = mobileUrl;
      return;
    }

    // On desktop: try the app protocol first, then fall back to web
    let fellBack = false;

    // Fallback if the protocol handler doesn't take over
    const fallbackTimer = setTimeout(() => {
      if (!win.closed) {
        fellBack = true;
        win.location = webUrl;
      }
    }, 1200); // ~1.2s is enough for the "Open WhatsApp" handoff prompt

    try {
      win.location = appUrl;
    } catch (_) {
      // If navigating to the custom scheme throws synchronously, fall back immediately
      clearTimeout(fallbackTimer);
      if (!win.closed) {
        fellBack = true;
        win.location = webUrl;
      }
    }

    // Safety second-fallback after a bit longer (covers edge cases)
    setTimeout(() => {
      if (!fellBack && !win.closed) {
        win.location = webUrl;
      }
    }, 3000);
  };
</script>




{% endblock %}